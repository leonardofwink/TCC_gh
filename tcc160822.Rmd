---
title: "TCC"
author: "Leonardo Fernandes Wink"
date: "`r format(Sys.time(), '%d/%m/%Y')`"
output:
  bookdown::html_document2:
    theme: flatly
    highlight: haddock
    keep_md: yes
    number_sections: yes
    toc: yes
    toc_float:
      collapsed: no
      smooth_scroll: no
    fig_caption: yes
    fig_width: 10
    fig_height: 6.66
    code_download: true
    code_folding: show
    widescreen: yes
    df_print: 'kable'
  pdf_document:
    toc: yes
  word_document: 
    toc: yes
    keep_md: yes
  github_document:
    html_preview: true
always_allow_html: yes
editor_options: 
  chunk_output_type: console
fig.align: center
---

```{r Rotina pra toda vez que abrir o documento, echo = FALSE}
# Abrir o GitHub Desktop
# Verificar se há pull pra ser feito
# Abrir o RStudio
```

# Brief explanation

Every boxplot means a monitoring point (Ponto de monitoramento (or PM) in portuguese). My goal here is to analyze the evolution between decades of each water quality parameter that compounds the Water Quality Index (WQI).

The river flows in the east-west direction as shown in the image below.

![](images/paste-7AD7027F.png)

The logic behind the sorting in the boxplots is because of 2 main reasons:

1.  The original monitoring point isn't easy to understand (8 digits, like `87409900`)
2.  Changing the original nomenclature to PM1, PM2 (...) makes it easier to understand that the last point has water contributions of every other point upstream.

# Pacotes necessários

## acessar os pacotes

```{r cronometrando quanto tempo cada chunk leva, setup, include=FALSE, echo=FALSE}
R_LIBS_SITE="E:\\Documents\\R\\R-4.2.2\\library"

knitr::knit_hooks$set(time_it = local({
   now <- NULL
   function(before, options) {
      if (before) {
         # record the current time before each chunk
         now <<- Sys.time()
      } else {
         # calculate the time difference after a chunk
         res <- difftime(Sys.time(), now)
         # return a character string to show the time
         paste("Tempo para esse code chunk ser rodado:", round(res, digits = 2), "s")
      }
   }
}))

knitr::opts_chunk$set(time_it = TRUE)
```

```{r Acessar os pacotes, message = FALSE, warning = TRUE}
pacman::p_load(
  # ETL/data wrangling
  readr, readxl, janitor,
  tidyverse,
  dplyr, 
  skimr, 
  # pillar, 
  # see,
  #modelsummary, 
  # report,
  # Data Viz
  rmarkdown, 
  knitr, 
  ## Gráficos
  ggplot2,
  GGally, 
  ggtext, 
  scales,
  ggbeeswarm, 
  gridExtra,
  cowplot,
  ## Tabelas
  SmartEDA, 
  kableExtra, 
  gtsummary,
  formattable,
  
  # Mapas
  leaflet,
  sf, raster,
  # leaflet, leaflet.extras,
  # rgdal, rgeos,
  # maps,
  # mapview,
  # ggmap
  )
# pacman::p_load(tibbletime)
# cite_packages()
```

### referenciando os pacotes

```{r referenciando os pacotes}
version$version.string
# citation(package = "tidyverse")
```

## importando a planilha

```{r Importando a planilha, echo = TRUE, message = TRUE, warning = FALSE}
plan_wide_19902020 <- read_delim("https://raw.githubusercontent.com/leonardofwink/TCC_gh/main/plan_wide_19902020.tsv",
                                 delim = "\t", 
                                 escape_double = FALSE,
                                 col_types = cols(
                                   Alcalinidade = col_double(),
                                   CODIGO = col_character(), 
                                   COORD_GEO_LAT_GRAU = col_double(),
                                   COORD_GEO_LONG_GRAU = col_double(),
                                   DATA_COLETA = col_date(format = "%d/%m/%Y"),
                                   Nitrato = col_double(), 
                                   Nitrito = col_double(),
                                   SDT = col_double(), 
                                   SST = col_double(),
                                   `Vazao` = col_double(), 
                                   `Vazao rio` = col_double()
                                 ),
                                 locale = locale(
                                   date_names = "pt", 
                                   decimal_mark = ",",
                                   grouping_mark = ""
                                 ),
                                 trim_ws = TRUE
) %>% 
  janitor::clean_names() %>% 
  rename(
    pH = p_h,
    iqa_pH = iqa_p_h,
    iqa_pH_2 = iqa_p_h_2,
    latitude = latitude_corrigida,
    longitude = longitude_corrigida
  ) %>% 
  mutate(
    ponto_monitoramento = case_when(
      codigo == "87398500" ~ "PM1",
      codigo == "87398980" ~ "PM2",
      codigo == "87398900" ~ "PM3",
      codigo == "87398950" ~ "PM4",
      codigo == "87405500" ~ "PM5",
      codigo == "87406900" ~ "PM6",
      codigo == "87409900" ~ "PM7"
    )
  ) %>% 
  dplyr::select(
    codigo, ponto_monitoramento, municipio, endereco, latitude, longitude, 
    everything()
    ) %>% 
  dplyr::select(
    -coord_geo_lat_grau,
    -coord_geo_long_grau,
    ) %>% #reordenando colunas
  arrange(data_coleta, ponto_monitoramento)
# teste <- plan_wide_19902020 %>%
#   dplyr::filter(data_coleta >= as.POSIXct("2010-01-01")) #this works
```

```{r Visualização da planilha importada, echo = FALSE}
paged_table(plan_wide_19902020,
            options = list(rows.print = 15,
                           cols.print = 10))
```

# data wrangling

Como há dados faltantes, no cálculo entre o produto das colunas, o R acaba interpretando como se fosse zero, mas na verdade é `NA`.

```{r data wrangling}
plan_wide_19902020 <- plan_wide_19902020 %>% 
   mutate(iqa = ifelse(iqa == 0, NA, iqa))

parametros_IQA <- plan_wide_19902020 %>%
  dplyr::select(
    codigo,
    ponto_monitoramento,
    pH,
    oxigenio_dissolvido,
    dbo,
    fosforo_total,
    escherichia_coli,
    nitrogenio_amoniacal,
    nitrogenio_kjeldahl,
    nitrogenio_total,
    turbidez,
    temperatura_agua,
    solidos_totais,
    condutividade,
    ano_coleta
  )

write.csv(parametros_IQA,
          "./parametros_IQA.csv",
          row.names = FALSE)
```

```{r futuro calculo de IQA, include = FALSE}
plan_wide_19902020 %>% 
  dplyr::select(starts_with("iqa_")) %>% 
  mutate(
    teste_iqa_calc = prod() #queria tentar gerar o produtório entre as colunas que já possuem o IQA^2
  )
```

# setting theme

```{r setting theme}
theme_grafs <- function(bg = "white", 
                        coloracao_letra = "black"){
  theme(
    plot.title = 
      element_text(
        hjust = 0.5,
        color = coloracao_letra,
        size = 19),
    
    axis.title.x = 
      # element_text(
      # color = coloracao_letra,
      # size = 15,
      # angle = 0,),
      element_blank(),
    axis.title.y = element_text(
      color = coloracao_letra,
      size = 15,
      angle = 90),
    
    axis.text.x = element_text(
      color = coloracao_letra,
      size = 17),
    axis.text.y = element_text(
      color = coloracao_letra,
      size = 17,
      angle = 0),
    
    strip.background = element_rect(fill = bg,
                                    linetype = 1,
                                    size = 0.5,
                                    color = "black"),
    strip.text = element_text(size = 17),
    panel.background = element_rect(fill = bg),
    plot.background = element_rect(fill = bg),
    plot.margin = margin(l = 5, r = 10,
                         b = 5, t = 5)
  )
}
```

# setting different timescales

```{r setting periodos, echo = TRUE}
plan_wide_19902020 <- plan_wide_19902020 %>% 
  mutate(
    periodo = if_else(
      ano_coleta <= 2000, 
      "1990-2000",
      if_else(
        ano_coleta <= 2010,
        "2000-2010",
        "2010-2020"
      )
    )
  )
```

O `code chunk` abaixo vai ser utilizado para a geração dos gráficos ao longo do tempo.

```{r, echo=TRUE}
periodo_inicial <- as.Date("1990-01-01", "%Y-%m-%d")
periodo_final <- as.Date("2021-01-01",  "%Y-%m-%d")
```

# setting sumaries

```{r Sumários, echo = FALSE}
sumario <- function(dados = plan_wide_19902020, parametro = x) {
  library(dplyr)
  dados %>% 
    # filter(ano_coleta>"1990" &
    #          ano_coleta<="2000") %>%
    dplyr::group_by(ponto_monitoramento, periodo) %>%
    summarize(
      min =
        min(x,
            na.rm = TRUE),
      p05 = 
        quantile(x, 0.05,
                 na.rm = TRUE),
      p20 =
        quantile(x, 0.20,
                 na.rm = TRUE),
      median =
        median(x,
               na.rm = TRUE),
      mean =
        mean(x,
             na.rm= TRUE),
      p80 =
        quantile(x, 0.80,
                 na.rm = TRUE),
      p95 =
        quantile(x, 0.95,
                 na.rm = TRUE),
      max =
        max(x,
            na.rm = TRUE),
      
      .groups = "drop"
      )
}
```

# EDA

```{r}
eda_all_time <- plan_wide_19902020 %>% 
  dplyr::select(
    oxigenio_dissolvido, 
    dbo, 
    fosforo_total, 
    solidos_totais, 
    escherichia_coli, 
    nitrogenio_amoniacal, 
    temperatura_agua, 
    turbidez, 
    pH, 
    condutividade, 
    periodo
  ) %>% 
  skimr::skim() %>% 
  arrange(
    desc(complete_rate)
  )
```

# Funções - boxplot

## criando função para gerar boxplots com percentil 20 e 80

```{r funcao percentil 80}
f <- function(x) {
  r <- quantile(x, probs = c(0.05, 0.20, 0.50, 0.80, 0.95))
  names(r) <- c("ymin", "lower", "middle", "upper", "ymax")
  return(r)
}
```

## Oxigênio Dissolvido

```{r gerando function graf od, echo = TRUE}
boxplot_od <- function(dados = plan_wide_19902020, eixo_x = codigo, eixo_y = oxigenio_dissolvido, titulo = "Oxigênio Dissolvido"){
  ggplot2::ggplot(
    data = dados,
    aes(
      x = {{eixo_x}},
      y = {{eixo_y}}
    )
  )+
    annotate("rect",
             xmin = -Inf, xmax = Inf,
             ymin = -Inf, ymax = 2,
             alpha = 1,
             fill = "#ac5079")+ #>pior classe
    annotate("rect",
             xmin = -Inf, xmax = Inf,
             ymin = 2, ymax = 4,
             alpha = 1,
             fill = "#eb5661")+ #classe 4
    annotate("rect",
             xmin = -Inf, xmax = Inf,
             ymin = 4, ymax = 5,
             alpha = 1,
             fill = "#fcf7ab")+ #classe 3
    annotate("rect",
             xmin = -Inf, xmax = Inf,
             ymin = 5, ymax = 6,
             alpha = 1,
             fill = "#70c18c")+ #classe 2
    annotate("rect",
             xmin = -Inf, xmax = Inf,
             ymin= 6, ymax = Inf,
             alpha = 1,
             fill = "#8dcdeb")+ #classe 1
    stat_summary(
      fun.data = f,
      geom = 'errorbar',
      width = 0.3,
      position = position_dodge(width = 0.65),
    )+
    stat_summary(
      fun.data = f,
      geom = "boxplot",
      width = 0.7,
      fill = '#F8F8FF',
      color = "black",
      outlier.shape = NA, #se deixar NA fica só o jitter, se não, deixa 1
    )+
    # facet_wrap(~periodo)+
    labs(
      title = titulo,
      x= NULL,
      y="mg/L"
    )+
    ggbeeswarm::geom_quasirandom(
      size = 1.2,
      alpha = .25,
      width = .07,
    )+
    scale_y_continuous(
      expand = expansion(mult = c(0,0)),
      n.breaks = 11,
      limits = c(-0.3,21)
    )+
    scale_x_discrete(limits = c("87398500",
                                "87398980",
                                "87398900",
                                "87398950",
                                "87405500",
                                "87406900",
                                "87409900"),
                     labels = c("PM1", "PM2", "PM3", "PM4", "PM5", "PM6", "PM7")
    )+
    geom_smooth(
      method = "lm",
      se=FALSE, #se deixar TRUE gera o intervalo de confiança de 95%
      aes(group = 1),
      alpha = .5,
      na.rm = TRUE,
      size = 1
    )+
    theme_grafs()
}
```

```{r gerando function ts_od, echo=TRUE}
ts_od <- function(dados = plan_wide_19902020, eixo_x = data_coleta, eixo_y = oxigenio_dissolvido, titulo = "Oxigênio Dissolvido"){
  dados %>%
    dplyr::filter(
      periodo == "1990-2000" | 
        periodo == "2000-2010" | 
        periodo == "2010-2020"
    ) %>%
    dplyr::select(ponto_monitoramento, oxigenio_dissolvido, data_coleta, periodo) %>%
    ggplot2::ggplot(
      data = .,
      aes(
        x = {{eixo_x}},
        y = {{eixo_y}}
      )
    )+
    annotate("rect",
             xmin = periodo_inicial, xmax = periodo_final,
             ymin = -Inf, ymax = 2,
             alpha = 1,
             fill = "#ac5079")+ #>pior classe
    annotate("rect",
             xmin = periodo_inicial, xmax = periodo_final,
             ymin = 2, ymax = 4,
             alpha = 1,
             fill = "#eb5661")+ #classe 4
    annotate("rect",
             xmin = periodo_inicial, xmax = periodo_final,
             ymin = 4, ymax = 5,
             alpha = 1,
             fill = "#fcf7ab")+ #classe 3
    annotate("rect",
             xmin = periodo_inicial, xmax = periodo_final,
             ymin = 5, ymax = 6,
             alpha = 1,
             fill = "#70c18c")+ #classe 2
    annotate("rect",
             xmin = periodo_inicial, xmax = periodo_final,
             ymin = 6, ymax = Inf,
             alpha = 1,
             fill = "#8dcdeb")+ #classe 1
    labs(
      title = titulo,
      x = NULL,
      y ="mg/L"
    )+
    geom_vline(
     xintercept = as.Date(c("2010-01-01", "2000-01-01"), "%Y-%m-%d"),
     color = "grey25",
     linetype = "dashed",
   )+
    geom_line(
      linewidth = 0.05,
      linetype = 9,
      # aes(color = codigo),
      na.rm = TRUE
    )+
    geom_point(
      size = 1,
      # aes(color = codigo),
      na.rm = TRUE
    )+
    scale_x_date(
      limits = as.Date(c(
        "1990-01-01", 
        "2021-01-01"
        # NA #pode usar NA também
      )),
      expand = c(0.0, 0.0),
      date_breaks = "5 years",
      minor_breaks = "1 year",
      date_labels = "%Y",
    )+
    facet_wrap(
      ~ponto_monitoramento,
      nrow = 4,
    )+
    theme_bw()+
    theme(
      plot.title = 
        element_text(
          hjust = 0.5,
          color = "black",
          size = 17),
      
      axis.title.x =
        element_text(
          color = "black",
          size = 15,
          angle = 0,),
      # element_blank(),
      axis.title.y = element_text(
        color = "black",
        size = 15,
        angle = 90),
      axis.text.x = element_text(
        color = "black",
        size = 13,
        angle = 0),
      axis.text.y = element_text(
        color = "black",
        size = 15,
        angle = 0),
      
      strip.background = element_rect(fill = "white",
                                      linetype = 1,
                                      size = 0.5,
                                      color = "black"),
      strip.text = element_text(size = 14),
      # panel.background = element_rect(fill = "white"),
      panel.spacing.x = unit(1, "lines"),
      
      plot.margin = margin(l = 5, r = 10,
                           b = 5, t = 5)
    )
}
```

## Demanda Bioquímica de Oxigênio

```{r gerando function graf dbo, echo = TRUE}
boxplot_dbo <- function(dados = plan_wide_19902020, eixo_x = codigo, eixo_y = dbo, titulo = "Demanda Bioquímica de Oxigênio"){
  ggplot2::ggplot(
    data = dados,
    aes(
      x = {{eixo_x}},
      y = {{eixo_y}}
    )
  )+
    annotate("rect",
             xmin=-Inf, xmax=Inf,
             ymin=10, ymax=Inf,
             alpha=1,
             fill="#ac5079")+ #>pior classe
    annotate("rect",
             xmin=-Inf, xmax=Inf,
             ymin=5, ymax=10,
             alpha=1,
             fill="#fcf7ab")+ #classe 3
    annotate("rect",
             xmin=-Inf, xmax=Inf,
             ymin=3, ymax=5,
             alpha=1,
             fill="#70c18c")+ #classe 2
    annotate("rect",
             xmin=-Inf, xmax=Inf,
             ymin=0, ymax=3,
             alpha=1,
             fill="#8dcdeb")+ #classe 1
    stat_summary(
      fun.data = f,
      geom = 'errorbar',
      width = 0.3,
      position = position_dodge(width = 0.65),
    )+
    stat_summary(
      fun.data = f,
      geom = "boxplot",
      width = 0.7,
      fill = '#F8F8FF',
      color = "black",
      outlier.shape = NA, #se deixar NA fica só o jitter, se não, deixa 1
    )+
    # facet_wrap(~periodo)+
    labs(title = titulo,
         x="Estação",
         y="mg/L",
         caption = "Leonardo Fernandes Wink"
    )+
    ggbeeswarm::geom_quasirandom(
      size = 1.2,
      alpha = .25,
      width = .07,
    )+
    scale_x_discrete(limits = c("87398500", 
                                "87398980", 
                                "87398900", 
                                "87398950", 
                                "87405500", 
                                "87406900", 
                                "87409900"),
                     labels = c("PM1", "PM2", "PM3", "PM4", "PM5", "PM6", "PM7")
    )+
    scale_y_continuous(expand = expansion(mult = c(0.03,0.03)),
                       n.breaks = 8,
                       limits = c(1,100),
                       trans = "log10")+
    geom_smooth(method = "lm",
                se=FALSE, #se deixar TRUE gera o intervalo de confiança de 95%
                aes(group=1),
                alpha=.5,
                na.rm = TRUE,
                size = 1)+
    theme_grafs()
}
```

```{r gerando function ts_dbo, echo = TRUE}
ts_dbo <- function(dados = plan_wide_19902020, eixo_x = data_coleta, eixo_y = dbo, titulo = "Demanda Bioquímica de Oxigênio"){
  dados %>%
    dplyr::filter(
      periodo == "1990-2000" | 
        periodo == "2000-2010" | 
        periodo == "2010-2020"
    ) %>%
    dplyr::select(ponto_monitoramento, dbo, data_coleta, periodo) %>%
    ggplot2::ggplot(
      data = .,
      aes(
        x = {{eixo_x}},
        y = {{eixo_y}}
      )
    )+
    annotate("rect",
             xmin = periodo_inicial, xmax = periodo_final,
             ymin = 10, ymax = Inf,
             alpha = 1,
             fill="#ac5079")+ #>pior classe
    annotate("rect",
             xmin = periodo_inicial, xmax = periodo_final,
             ymin = 5, ymax = 10,
             alpha = 1,
             fill="#fcf7ab")+ #classe 3
    annotate("rect",
             xmin = periodo_inicial, xmax = periodo_final,
             ymin = 3, ymax = 5,
             alpha = 1,
             fill="#70c18c")+ #classe 2
    annotate("rect",
             xmin = periodo_inicial, xmax = periodo_final,
             ymin = -Inf, ymax = 3,
             alpha = 1,
             fill = "#8dcdeb")+ #classe 1
    labs(
      title = titulo,
      x = NULL,
      y ="mg/L"
    )+
    geom_vline(
     xintercept = as.Date(c("2010-01-01", "2000-01-01"), "%Y-%m-%d"),
     color = "grey25",
     linetype = "dashed",
   )+
    geom_line(
      linewidth = 0.05,
      linetype = 9,
      # aes(color = codigo),
      na.rm = TRUE
    )+
    geom_point(
      size = 1,
      # aes(color = codigo),
      na.rm = TRUE
    )+
    scale_x_date(
      limits = as.Date(c(
        "1990-01-01", 
        "2021-01-01"
        # NA #pode usar NA também
      )),
      expand = c(0.0, 0.0),
      date_breaks = "5 years",
      minor_breaks = "1 year",
      date_labels = "%Y",
    )+
    facet_wrap(
      ~ponto_monitoramento,
      nrow = 4,
    )+
    theme_bw()+
    theme(
      plot.title = 
        element_text(
          hjust = 0.5,
          color = "black",
          size = 17),
      
      axis.title.x =
        element_text(
          color = "black",
          size = 15,
          angle = 0,),
      # element_blank(),
      axis.title.y = element_text(
        color = "black",
        size = 15,
        angle = 90),
      axis.text.x = element_text(
        color = "black",
        size = 13,
        angle = 0),
      axis.text.y = element_text(
        color = "black",
        size = 15,
        angle = 0),
      
      strip.background = element_rect(fill = "white",
                                      linetype = 1,
                                      size = 0.5,
                                      color = "black"),
      strip.text = element_text(size = 14),
      # panel.background = element_rect(fill = "white"),
      panel.spacing.x = unit(1, "lines"),
      
      plot.margin = margin(l = 5, r = 10,
                           b = 5, t = 5)
    )
}
```

## Fósforo total

```{r gerando function graf ptot, echo = TRUE}
boxplot_ptot <- function(dados = plan_wide_19902020, eixo_x = codigo, eixo_y = fosforo_total, titulo = "Fósforo total"){
  ggplot2::ggplot(
    data = dados,
    aes(
      x = {{eixo_x}},
      y = {{eixo_y}}
    )
  )+
   annotate("rect",
            xmin=-Inf,
            xmax=Inf,
            ymin=0.15,
            ymax=Inf,
            alpha=1,
            fill="#ac5079")+ #>pior classe
   annotate("rect",
            xmin=-Inf,
            xmax=Inf,
            ymin=0.1,
            ymax=0.15,
            alpha=1,
            fill="#fcf7ab")+ #classe 3
   annotate("rect",
            xmin=-Inf,
            xmax=Inf,
            ymin=0,
            ymax=0.1,
            alpha=1,
            fill="#8dcdeb")+ #classe 1
  stat_summary(
     fun.data = f,
     geom = 'errorbar',
     width = 0.3,
     position = position_dodge(width = 0.65),
   )+
   stat_summary(
     fun.data = f,
     geom = "boxplot",
     width = 0.7,
     fill = '#F8F8FF',
     color = "black",
     outlier.shape = NA, #se deixar NA fica só o jitter, se não, deixa 1
   )+
    labs(title = titulo,
         x="Estação",
         y="mg/L")+
   scale_y_continuous(expand = expansion(mult = c(0.03,0.03)),
                      n.breaks = 8,
                      limits = c(min(plan_wide_19902020$fosforo_total, na.rm = TRUE),
                                 max(plan_wide_19902020$fosforo_total), na.rm = TRUE),
                      trans = "log10",
                      labels = scales::number_format(accuracy = .001,
                                                     decimal.mark = ",",
                                                     big.mark = " ")
                      )+
    ggbeeswarm::geom_quasirandom(
       size = 1.2,
       alpha = .25,
       width = .07,
    )+
    scale_x_discrete(limits = c("87398500", 
                                "87398980", 
                                "87398900", 
                                "87398950", 
                                "87405500", 
                                "87406900", 
                                "87409900"),
                     labels = c("PM1", "PM2", "PM3", "PM4", "PM5", "PM6", "PM7")
    )+
    geom_smooth(method = "lm",
                se=FALSE, #se deixar TRUE gera o intervalo de confiança de 95%
                aes(group=1),
                alpha=.5,
                na.rm = TRUE,
                size = 1)+
    theme_grafs()
}
```

```{r gerando function ts_ptot, echo = TRUE}
ts_ptot <- function(dados = plan_wide_19902020, eixo_x = data_coleta, eixo_y = fosforo_total, titulo = "Fósforo total"){
  dados %>%
    dplyr::filter(
      periodo == "1990-2000" | 
        periodo == "2000-2010" | 
        periodo == "2010-2020"
    ) %>%
    dplyr::select(ponto_monitoramento, fosforo_total, data_coleta, periodo) %>%
    ggplot2::ggplot(
      data = .,
      aes(
        x = {{eixo_x}},
        y = {{eixo_y}}
      )
    )+
    annotate("rect",
            xmin = periodo_inicial, xmax = periodo_final,
            ymin=0.15, ymax=Inf,
            alpha=1,
            fill="#ac5079")+ #>pior classe
   annotate("rect",
           xmin = periodo_inicial, xmax = periodo_final,
            ymin=0.1, ymax=0.15,
            alpha=1,
            fill="#fcf7ab")+ #classe 3
   annotate("rect",
            xmin = periodo_inicial, xmax = periodo_final,
            ymin=0,ymax=0.1,
            alpha=1,
            fill="#8dcdeb")+ #classe 1
    labs(
      title = titulo,
      x = NULL,
      y ="mg/L"
    )+
    geom_vline(
     xintercept = as.Date(c("2010-01-01", "2000-01-01"), "%Y-%m-%d"),
     color = "grey25",
     linetype = "dashed",
   )+
    geom_line(
      linewidth = 0.05,
      linetype = 9,
      # aes(color = codigo),
      na.rm = TRUE
    )+
    geom_point(
      size = 1,
      # aes(color = codigo),
      na.rm = TRUE
    )+
    scale_x_date(
      limits = as.Date(c(
        "1990-01-01", 
        "2021-01-01"
        # NA #pode usar NA também
      )),
      expand = c(0.0, 0.0),
      date_breaks = "5 years",
      minor_breaks = "1 year",
      date_labels = "%Y",
    )+
    facet_wrap(
      ~ponto_monitoramento,
      nrow = 4,
    )+
    theme_bw()+
    theme(
      plot.title = 
        element_text(
          hjust = 0.5,
          color = "black",
          size = 17),
      
      axis.title.x =
        element_text(
          color = "black",
          size = 15,
          angle = 0,),
      # element_blank(),
      axis.title.y = element_text(
        color = "black",
        size = 15,
        angle = 90),
      axis.text.x = element_text(
        color = "black",
        size = 13,
        angle = 0),
      axis.text.y = element_text(
        color = "black",
        size = 15,
        angle = 0),
      
      strip.background = element_rect(fill = "white",
                                      linetype = 1,
                                      size = 0.5,
                                      color = "black"),
      strip.text = element_text(size = 14),
      # panel.background = element_rect(fill = "white"),
      panel.spacing.x = unit(1, "lines"),
      
      plot.margin = margin(l = 5, r = 10,
                           b = 5, t = 5)
    )
}
```

## Escherichia coli

```{r funcao-graf-ecoli, echo = TRUE}
boxplot_ecoli <- function(dados = plan_wide_19902020, eixo_x = codigo, eixo_y = escherichia_coli, titulo = "*Escherichia coli*"){
  ggplot2::ggplot(
    data = dados,
    aes(
      x = {{eixo_x}},
      y = {{eixo_y}}
    )
  )+
    annotate("rect",
             xmin=-Inf, xmax=Inf,
             ymin=3200, ymax=Inf,
             alpha=1,
             fill="#ac5079")+ #>pior classe
    annotate("rect",
             xmin=-Inf, xmax=Inf,
             ymin=800, ymax=3200,
             alpha=1,
             fill="#fcf7ab")+ #classe 3
    annotate("rect",
             xmin=-Inf, xmax=Inf,
             ymin=160, ymax=800,
             alpha=1,
             fill="#70c18c")+ #classe 2
    annotate("rect",
             xmin=-Inf, xmax=Inf,
             ymin=0, ymax=160,
             alpha=1,
             fill="#8dcdeb")+ #classe 1
    stat_summary(
      fun.data = f,
      geom = 'errorbar',
      width = 0.3,
      position = position_dodge(width = 0.65),
    )+
    stat_summary(
      fun.data = f,
      geom = "boxplot",
      width = 0.7,
      fill = '#F8F8FF',
      color = "black",
      outlier.shape = NA, #se deixar NA fica só o jitter, se não, deixa 1
    )+
    # facet_wrap(~periodo)+
    labs(title = titulo,
         x="Estação",
         y="NMP/100mL")+
    ggbeeswarm::geom_quasirandom(
      size = 1.2,
      alpha = .25,
      width = .07,
    )+
    scale_x_discrete(limits = c("87398500", 
                                "87398980", 
                                "87398900", 
                                "87398950", 
                                "87405500", 
                                "87406900", 
                                "87409900"),
                     labels = c("PM1", "PM2", "PM3", "PM4", "PM5", "PM6", "PM7")
    )+
    scale_y_log10(
      breaks = trans_breaks("log10", function(x) 10^x),
      labels = trans_format("log10", math_format(10^.x)),
      expand = expansion(mult = c(0.05, 0.25)),
      n.breaks = 9,
    )+
    annotation_logticks(sides = "l",
                        size = 0.01,
                        outside = TRUE)+
    coord_cartesian(clip = "off")+
    geom_smooth(method = "lm",
                se=FALSE, #se deixar TRUE gera o intervalo de confiança de 95%
                aes(group=1),
                alpha=.5,
                na.rm = TRUE,
                size = 1)+
    theme_grafs()+
    theme(
      # axis.text.y = element_text(
      #   angle = 90, 
      #   # size=15,
      #   # face=2
      # ),
      plot.title = 
        element_markdown(
          hjust = 0.5,
          color = "black",
          size = 19),
      
      panel.spacing.x = unit(0.7, "lines"),
      axis.ticks.length.y = unit(0.3, "cm"),
    )
}
```

```{r gerando function ts_ecoli, echo = TRUE}
ts_ecoli <- function(dados = plan_wide_19902020, eixo_x = data_coleta, eixo_y = escherichia_coli, titulo = "*Escherichia coli*"){
  dados %>%
    dplyr::filter(
      periodo == "1990-2000" | 
        periodo == "2000-2010" | 
        periodo == "2010-2020"
    ) %>%
    dplyr::select(ponto_monitoramento, escherichia_coli, data_coleta, periodo) %>%
    ggplot2::ggplot(
      data = .,
      aes(
        x = {{eixo_x}},
        y = {{eixo_y}}
      )
    )+
    annotate("rect",
             xmin = periodo_inicial, xmax = periodo_final,
             ymin=3200, ymax=Inf,
             alpha=1,
             fill="#ac5079")+ #>pior classe
    annotate("rect",
             xmin = periodo_inicial, xmax = periodo_final,
             ymin=800, ymax=3200,
             alpha=1,
             fill="#fcf7ab")+ #classe 3
    annotate("rect",
             xmin = periodo_inicial, xmax = periodo_final,
             ymin=160, ymax=800,
             alpha=1,
             fill="#70c18c")+ #classe 2
    annotate("rect",
             xmin = periodo_inicial, xmax = periodo_final,
             ymin=0, ymax=160,
             alpha=1,
             fill="#8dcdeb")+ #classe 1
    labs(
      title = titulo,
      x = NULL,
      y ="mg/L"
    )+
    geom_vline(
     xintercept = as.Date(c("2010-01-01", "2000-01-01"), "%Y-%m-%d"),
     color = "grey25",
     linetype = "dashed",
   )+
    geom_line(
      linewidth = 0.05,
      linetype = 9,
      # aes(color = codigo),
      na.rm = TRUE
    )+
    geom_point(
      size = 1,
      # aes(color = codigo),
      na.rm = TRUE
    )+
    scale_x_date(
      limits = as.Date(c(
        "1990-01-01", 
        "2021-01-01"
        # NA #pode usar NA também
      )),
      expand = c(0.0, 0.0),
      date_breaks = "5 years",
      minor_breaks = "1 year",
      date_labels = "%Y",
    )+
    facet_wrap(
      ~ponto_monitoramento,
      nrow = 4,
    )+
    theme_bw()+
    theme(
      plot.title = 
        element_markdown(
          hjust = 0.5,
          color = "black",
          size = 17),
      
      axis.title.x =
        element_text(
          color = "black",
          size = 15,
          angle = 0,),
      # element_blank(),
      axis.title.y = element_text(
        color = "black",
        size = 15,
        angle = 90),
      axis.text.x = element_text(
        color = "black",
        size = 13,
        angle = 0),
      axis.text.y = element_text(
        color = "black",
        size = 15,
        angle = 0),
      
      strip.background = element_rect(fill = "white",
                                      linetype = 1,
                                      size = 0.5,
                                      color = "black"),
      strip.text = element_text(size = 14),
      # panel.background = element_rect(fill = "white"),
      panel.spacing.x = unit(1, "lines"),
      # axis.ticks.length.y = unit(0.3, "cm"),
      
      plot.margin = margin(l = 5, r = 10,
                           b = 5, t = 5)
    )
}
```

## Nitrogênio Amoniacal

```{r gerando function graf namon, echo = TRUE}
boxplot_namon <- function(dados = plan_wide_19902020, eixo_x = codigo, eixo_y = nitrogenio_amoniacal, titulo = "Nitrogênio Amoniacal"){
  ggplot2::ggplot(
    data = dados,
    aes(
      x = {{eixo_x}},
      y = {{eixo_y}}
    )
  )+
   annotate("rect",
            xmin=-Inf,
            xmax=Inf,
            ymin=13.3,
            ymax=Inf,
            alpha=1,
            fill="#ac5079")+ #>pior classe
   annotate("rect",
            xmin=-Inf,
            xmax=Inf,
            ymin=3.7,
            ymax=13.3,
            alpha=1,
            fill="#fcf7ab")+ #classe 3
   annotate("rect",
            xmin=-Inf,
            xmax=Inf,
            ymin=0,
            ymax=3.7,
            alpha=1,
            fill="#8dcdeb")+ #classe 1
   stat_summary(
     fun.data = f,
     geom = 'errorbar',
     width = 0.3,
     position = position_dodge(width = 0.65),
   )+
   stat_summary(
     fun.data = f,
     geom = "boxplot",
     width = 0.7,
     fill = '#F8F8FF',
     color = "black",
     outlier.shape = NA, #se deixar NA fica só o jitter, se não, deixa 1
   )+
   # facet_wrap(~periodo)+
   labs(title = titulo,
        x="Estação",
        y="mg/L")+
   scale_y_continuous(expand = expansion(mult = c(0.01, 0.05)),
                      n.breaks = 9,
                      limits = c(min(plan_wide_19902020$nitrogenio_amoniacal, na.rm = TRUE),
                                 max(plan_wide_19902020$nitrogenio_amoniacal, na.rm = TRUE)),
                      trans = "log10",
                      labels = scales::number_format(accuracy = .001,
                                                     decimal.mark = ",",
                                                     big.mark = " "))+
   ggbeeswarm::geom_quasirandom(
     size = 1.2,
     alpha = .25,
     width = .07,
   )+
   scale_x_discrete(limits = c("87398500", 
                               "87398980", 
                               "87398900", 
                               "87398950", 
                               "87405500", 
                               "87406900", 
                               "87409900"),
                    labels = c("PM1", "PM2", "PM3", "PM4", "PM5", "PM6", "PM7")
   )+
   geom_smooth(method = "lm",
               se=FALSE, #se deixar TRUE gera o intervalo de confiança de 95%
               aes(group=1),
               alpha=.5,
               na.rm = TRUE,
               size = 1)+
   theme_grafs()
}
```

```{r gerando function graf namon line, echo = TRUE}
ts_nitro <- function(dados = plan_wide_19902020, eixo_x = data_coleta, eixo_y = nitrogenio_amoniacal, titulo = "Nitrogênio Amoniacal"){
  dados %>%
    dplyr::filter(
      periodo == "1990-2000" | 
        periodo == "2000-2010" | 
        periodo == "2010-2020"
    ) %>%
    dplyr::select(ponto_monitoramento, nitrogenio_amoniacal, data_coleta, periodo) %>%
    ggplot2::ggplot(
      data = .,
      aes(
        x = {{eixo_x}},
        y = {{eixo_y}}
      )
    )+
    annotate("rect",
             xmin = periodo_inicial, xmax = periodo_final,
             ymin = 13.3, ymax = Inf,
             alpha = 1,
             fill = "#ac5079")+ #>pior classe
    annotate("rect",
             xmin = periodo_inicial, xmax = periodo_final,
             ymin = 3.7, ymax = 13.3,
             alpha = 1,
             fill = "#fcf7ab")+ #classe 3
    annotate("rect",
             xmin = periodo_inicial, xmax = periodo_final,
             ymin = 0, ymax = 3.7,
             alpha = 1,
             fill = "#8dcdeb")+ #classe 1
    labs(
      title = titulo,
      x = NULL,
      y ="mg/L"
    )+
    geom_vline(
     xintercept = as.Date(c("2010-01-01", "2000-01-01"), "%Y-%m-%d"),
     color = "grey25",
     linetype = "dashed",
   )+
    geom_line(
      linewidth = 0.05,
      linetype = 9,
      # aes(color = codigo),
      na.rm = TRUE
    )+
    geom_point(
      size = 1,
      # aes(color = codigo),
      na.rm = TRUE
    )+
    scale_x_date(
      limits = as.Date(c(
        "1990-01-01", 
        "2021-01-01"
        # NA #pode usar NA também
      )),
      expand = c(0.0, 0.0),
      date_breaks = "5 years",
      minor_breaks = "1 year",
      date_labels = "%Y",
    )+
    facet_wrap(
      ~ponto_monitoramento,
      nrow = 4,
    )+
    theme_bw()+
    theme(
      plot.title = 
        element_text(
          hjust = 0.5,
          color = "black",
          size = 17),
      
      axis.title.x =
        element_text(
          color = "black",
          size = 15,
          angle = 0,),
      # element_blank(),
      axis.title.y = element_text(
        color = "black",
        size = 15,
        angle = 90),
      axis.text.x = element_text(
        color = "black",
        size = 13,
        angle = 0),
      axis.text.y = element_text(
        color = "black",
        size = 15,
        angle = 0),
      
      strip.background = element_rect(fill = "white",
                                      linetype = 1,
                                      size = 0.5,
                                      color = "black"),
      strip.text = element_text(size = 14),
      # panel.background = element_rect(fill = "white"),
      panel.spacing.x = unit(1, "lines"),
      
      plot.margin = margin(l = 5, r = 10,
                           b = 5, t = 5)
    )
}
```

## Turbidez

```{r gerando function graf turb, echo = TRUE}
boxplot_turb <- function(dados = plan_wide_19902020, eixo_x = codigo, eixo_y = turbidez, titulo = "Turbidez"){
  ggplot2::ggplot(
    data = dados,
    aes(
      x = {{eixo_x}},
      y = {{eixo_y}}
    )
  )+
    annotate("rect",
             xmin=-Inf, xmax=Inf,
             ymin=100, ymax=Inf,
             alpha=1,
             fill="#ac5079")+ #>pior classe
    annotate("rect",
             xmin=-Inf, xmax=Inf,
            ymin=40, ymax=100,
            alpha=1,
            fill="#fcf7ab")+ #classe 3
   annotate("rect",
            xmin=-Inf, xmax=Inf,
            ymin=0, ymax=40,
            alpha=1,
            fill="#8dcdeb")+ #classe 1
   stat_summary(
     fun.data = f,
     geom = 'errorbar',
     width = 0.3,
     position = position_dodge(width = 0.65),
   )+
   stat_summary(
     fun.data = f,
     geom = "boxplot",
     width = 0.7,
     fill = '#F8F8FF',
     color = "black",
     outlier.shape = NA, #se deixar NA fica só o jitter, se não, deixa 1
   )+
   labs(title = titulo,
        x="Estação",
        y="UNT")+
    scale_y_continuous(expand = expansion(mult = c(0.05, 0.05)),
                       n.breaks = 8,
                       limits = c(
                         # 1,
                         min(plan_wide_19902020$turbidez, na.rm = TRUE),
                         # 500
                         max(plan_wide_19902020$turbidez, na.rm = TRUE)
                       ),
                       trans = "log10",
                       labels = scales::number_format(accuracy = 1,
                                                      decimal.mark = ",",
                                                      big.mark = " "))+
    ggbeeswarm::geom_quasirandom(
      size = 1.2,
     alpha = .25,
     width = .07,
   )+
   scale_x_discrete(limits = c("87398500", 
                               "87398980", 
                               "87398900", 
                               "87398950", 
                               "87405500", 
                               "87406900", 
                               "87409900"),
                    labels = c("PM1", "PM2", "PM3", "PM4", "PM5", "PM6", "PM7")
   )+
   geom_smooth(method = "lm",
               se=FALSE, #se deixar TRUE gera o intervalo de confiança de 95%
               aes(group=1),
               alpha=.5,
               na.rm = TRUE,
               size = 1)+
    theme_grafs()
}
```

```{r gerando function graf turbidez line, echo = TRUE}
ts_turbidez <- function(dados = plan_wide_19902020, eixo_x = data_coleta, eixo_y = turbidez, titulo = "Turbidez"){
  dados %>%
    dplyr::filter(
      periodo == "1990-2000" | 
        periodo == "2000-2010" | 
        periodo == "2010-2020"
    ) %>%
    dplyr::select(ponto_monitoramento, turbidez, data_coleta, periodo) %>%
    ggplot2::ggplot(
      data = .,
      aes(
        x = {{eixo_x}},
        y = {{eixo_y}}
      )
    )+
    annotate("rect",
             xmin = periodo_inicial, xmax = periodo_final,
             ymin=100, ymax=Inf,
             alpha=1,
             fill="#ac5079")+ #>pior classe
    annotate("rect",
             xmin = periodo_inicial, xmax = periodo_final,
            ymin=40, ymax=100,
            alpha=1,
            fill="#fcf7ab")+ #classe 3
   annotate("rect",
           xmin = periodo_inicial, xmax = periodo_final,
            ymin=0, ymax=40,
            alpha=1,
            fill="#8dcdeb")+ #classe 1
    labs(
      title = titulo,
      x = NULL,
      y ="mg/L"
    )+
    geom_vline(
     xintercept = as.Date(c("2010-01-01", "2000-01-01"), "%Y-%m-%d"),
     color = "grey25",
     linetype = "dashed",
   )+
    geom_line(
      linewidth = 0.05,
      linetype = 9,
      # aes(color = codigo),
      na.rm = TRUE
    )+
    geom_point(
      size = 1,
      # aes(color = codigo),
      na.rm = TRUE
    )+
    scale_x_date(
      limits = as.Date(c(
        "1990-01-01", 
        "2021-01-01"
        # NA #pode usar NA também
      )),
      expand = c(0.0, 0.0),
      date_breaks = "5 years",
      minor_breaks = "1 year",
      date_labels = "%Y",
    )+
    facet_wrap(
      ~ponto_monitoramento,
      nrow = 4,
    )+
    theme_bw()+
    theme(
      plot.title = 
        element_text(
          hjust = 0.5,
          color = "black",
          size = 17),
      
      axis.title.x =
        element_text(
          color = "black",
          size = 15,
          angle = 0,),
      # element_blank(),
      axis.title.y = element_text(
        color = "black",
        size = 15,
        angle = 90),
      axis.text.x = element_text(
        color = "black",
        size = 13,
        angle = 0),
      axis.text.y = element_text(
        color = "black",
        size = 15,
        angle = 0),
      
      strip.background = element_rect(fill = "white",
                                      linetype = 1,
                                      size = 0.5,
                                      color = "black"),
      strip.text = element_text(size = 14),
      # panel.background = element_rect(fill = "white"),
      panel.spacing.x = unit(1, "lines"),
      
      plot.margin = margin(l = 5, r = 10,
                           b = 5, t = 5)
    )
}
```

## pH

```{r gerando function graf pH, echo = TRUE}
boxplot_pH <- function(dados = plan_wide_19902020, eixo_x = codigo, eixo_y = pH, titulo = "pH"){
  ggplot2::ggplot(
    data = dados,
    aes(
      x = {{eixo_x}},
      y = {{eixo_y}}
    )
  )+
    annotate("rect",
            xmin = -Inf, xmax = Inf,
            ymin = -Inf, ymax = 6,
            alpha = 1,
            fill="#eb5661")+ #classe 4
   annotate("rect",
            xmin = -Inf, xmax = Inf,
            ymin = 9, ymax = Inf,
            alpha = 1,
            fill="#eb5661")+ #classe 4
   annotate("rect",
            xmin = -Inf, xmax = Inf,
            ymin = 6, ymax = 9,
            alpha = 1,
            fill="#8dcdeb")+ #classe 1
    stat_summary(
      fun.data = f,
      geom = 'errorbar',
      width = 0.3,
      position = position_dodge(width = 0.65),
    )+
    stat_summary(
      fun.data = f,
      geom = "boxplot",
      width = 0.7,
      fill = '#F8F8FF',
      color = "black",
      outlier.shape = NA, #se deixar NA fica só o jitter, se não, deixa 1
    )+
    labs(
      title = titulo,
      x = NULL,
      y = NULL,
    )+
    ggbeeswarm::geom_quasirandom(
      size = 1.2,
      alpha = .25,
      width = .07,
    )+
    scale_y_continuous(expand = expansion(mult = c(0.05, 0.05)),
                       # n.breaks = 5,
                       breaks = c(4.5, 6, 7.5, 9, 10.5),
                       limits = c(4.5, 10.5),
                       labels = scales::number_format(accuracy = .1,
                                                      decimal.mark = ",",
                                                      big.mark = " "))+
    scale_x_discrete(limits = c("87398500",
                                "87398980",
                                "87398900",
                                "87398950",
                                "87405500",
                                "87406900",
                                "87409900"),
                     labels = c("PM1", "PM2", "PM3", "PM4", "PM5", "PM6", "PM7")
    )+
    geom_smooth(
      method = "lm",
      se=FALSE, #se deixar TRUE gera o intervalo de confiança de 95%
      aes(group = 1),
      alpha = .5,
      na.rm = TRUE,
      size = 1
    )+
    theme_grafs()
}
```

```{r gerando function ts_pH, echo = TRUE}
ts_pH <- function(dados = plan_wide_19902020, eixo_x = data_coleta, eixo_y = pH, titulo = "pH"){
  dados %>%
    dplyr::filter(
      periodo == "1990-2000" | 
        periodo == "2000-2010" | 
        periodo == "2010-2020"
    ) %>%
    dplyr::select(ponto_monitoramento, pH, data_coleta, periodo) %>%
    ggplot2::ggplot(
      data = .,
      aes(
        x = {{eixo_x}},
        y = {{eixo_y}}
      )
    )+
    annotate("rect",
             xmin = periodo_inicial, xmax = periodo_final,
             ymin = -Inf, ymax = 6,
             alpha = 1,
             fill="#eb5661")+ #classe 4
    annotate("rect",
             xmin = periodo_inicial, xmax = periodo_final,
             ymin = 9, ymax = Inf,
             alpha = 1,
             fill="#eb5661")+ #classe 4
    annotate("rect",
             xmin = periodo_inicial, xmax = periodo_final,
             ymin = 6, ymax = 9,
             alpha = 1,
             fill="#8dcdeb")+ #classe 1
    labs(
      title = titulo,
      x = NULL,
      y = NULL,
    )+
    geom_vline(
      xintercept = as.Date(c("2010-01-01", "2000-01-01"), "%Y-%m-%d"),
     color = "grey25",
     linetype = "dashed",
   )+
    geom_line(
      linewidth = 0.05,
      linetype = 9,
      # aes(color = codigo),
      na.rm = TRUE
    )+
    geom_point(
      size = 1,
      # aes(color = codigo),
      na.rm = TRUE
    )+
    scale_x_date(
      limits = as.Date(c(
        "1990-01-01", 
        "2021-01-01"
        # NA #pode usar NA também
      )),
      expand = c(0.0, 0.0),
      date_breaks = "5 years",
      minor_breaks = "1 year",
      date_labels = "%Y",
    )+
    facet_wrap(
      ~ponto_monitoramento,
      nrow = 4,
    )+
    theme_bw()+
    theme(
      plot.title = 
        element_text(
          hjust = 0.5,
          color = "black",
          size = 17),
      
      axis.title.x =
        element_text(
          color = "black",
          size = 15,
          angle = 0,),
      # element_blank(),
      axis.title.y = element_text(
        color = "black",
        size = 15,
        angle = 90),
      axis.text.x = element_text(
        color = "black",
        size = 13,
        angle = 0),
      axis.text.y = element_text(
        color = "black",
        size = 15,
        angle = 0),
      
      strip.background = element_rect(fill = "white",
                                      linetype = 1,
                                      size = 0.5,
                                      color = "black"),
      strip.text = element_text(size = 14),
      # panel.background = element_rect(fill = "white"),
      panel.spacing.x = unit(1, "lines"),
      
      plot.margin = margin(l = 5, r = 10,
                           b = 5, t = 5)
    )
}
```

## Sólidos Totais

```{r gerando function graf SolTot, echo = TRUE}
boxplot_solidos_totais <- function(dados = plan_wide_19902020, eixo_x = codigo, eixo_y = solidos_totais, titulo = "Sólidos totais"){
  ggplot2::ggplot(
    data = dados,
    aes(
      x = {{eixo_x}},
      y = {{eixo_y}}
    )
  )+
   annotate("rect",
            xmin = -Inf, xmax = Inf,
            ymin = 500, ymax = Inf,
            alpha = 1,
            fill = "#ac5079")+ #>pior classe
   annotate("rect",
            xmin = -Inf, xmax = Inf,
            ymin = 0, ymax = 500,
            alpha = 1,
            fill = "#8dcdeb")+ #classe 1
   stat_summary(
     fun.data = f,
     geom = 'errorbar',
     width = 0.3,
     position = position_dodge(width = 0.65),
   )+
   stat_summary(
     fun.data = f,
     geom = "boxplot",
     width = 0.7,
     fill = '#F8F8FF',
     color = "black",
     outlier.shape = NA, #se deixar NA fica só o jitter, se não, deixa 1
   )+
   labs(title = titulo,
        x= NULL,
        y="")+
   scale_y_continuous(expand = expansion(mult = c(0.01, 0.05)),
                      n.breaks = 8,
                      limits = c(min(plan_wide_19902020$solidos_totais, na.rm = TRUE),
                                 max(plan_wide_19902020$solidos_totais, na.rm = TRUE)),
                      labels = scales::number_format(accuracy = 1,
                                                     decimal.mark = ",",
                                                     big.mark = " "),
                      trans = "log10")+
   ggbeeswarm::geom_quasirandom(
     size = 1.2,
     alpha = .25,
     width = .07,
   )+
   scale_x_discrete(limits = c("87398500", 
                               "87398980", 
                               "87398900", 
                               "87398950", 
                               "87405500", 
                               "87406900", 
                               "87409900"),
                    labels = c("PM1", "PM2", "PM3", "PM4", "PM5", "PM6", "PM7")
   )+
   geom_smooth(method = "lm",
               se=FALSE, #se deixar TRUE gera o intervalo de confiança de 95%
               aes(group=1),
               alpha=.5,
               na.rm = TRUE,
               size = 1)+
   theme_grafs()
}
```

```{r gerando function ts_soltot, echo = TRUE}
ts_solidos_totais <- function(dados = plan_wide_19902020, eixo_x = data_coleta, eixo_y = solidos_totais, titulo = "Sólidos totais"){
  dados %>%
    dplyr::filter(
      periodo == "1990-2000" | 
        periodo == "2000-2010" | 
        periodo == "2010-2020"
    ) %>%
    dplyr::select(ponto_monitoramento, solidos_totais, data_coleta, periodo) %>%
    ggplot2::ggplot(
      data = .,
      aes(
        x = {{eixo_x}},
        y = {{eixo_y}}
      )
    )+
       annotate("rect",
            xmin = periodo_inicial, xmax = periodo_final,
            ymin = 500, ymax = Inf,
            alpha = 1,
            fill = "#ac5079")+ #>pior classe
   annotate("rect",
            xmin = periodo_inicial, xmax = periodo_final,
            ymin = 0, ymax = 500,
            alpha = 1,
            fill = "#8dcdeb")+ #classe 1
    labs(
      title = titulo,
      x = NULL,
      y = NULL,
    )+
    geom_vline(
      xintercept = as.Date(c("2010-01-01", "2000-01-01"), "%Y-%m-%d"),
     color = "grey25",
     linetype = "dashed",
   )+
    geom_line(
      linewidth = 0.05,
      linetype = 9,
      # aes(color = codigo),
      na.rm = TRUE
    )+
    geom_point(
      size = 1,
      # aes(color = codigo),
      na.rm = TRUE
    )+
    scale_x_date(
      limits = as.Date(c(
        "1990-01-01", 
        "2021-01-01"
        # NA #pode usar NA também
      )),
      expand = c(0.0, 0.0),
      date_breaks = "5 years",
      minor_breaks = "1 year",
      date_labels = "%Y",
    )+
    facet_wrap(
      ~ponto_monitoramento,
      nrow = 4,
    )+
    theme_bw()+
    theme(
      plot.title = 
        element_text(
          hjust = 0.5,
          color = "black",
          size = 17),
      
      axis.title.x =
        element_text(
          color = "black",
          size = 15,
          angle = 0,),
      # element_blank(),
      axis.title.y = element_text(
        color = "black",
        size = 15,
        angle = 90),
      axis.text.x = element_text(
        color = "black",
        size = 13,
        angle = 0),
      axis.text.y = element_text(
        color = "black",
        size = 15,
        angle = 0),
      
      strip.background = element_rect(fill = "white",
                                      linetype = 1,
                                      size = 0.5,
                                      color = "black"),
      strip.text = element_text(size = 14),
      # panel.background = element_rect(fill = "white"),
      panel.spacing.x = unit(1, "lines"),
      
      plot.margin = margin(l = 5, r = 10,
                           b = 5, t = 5)
    )
}
```

## Condutividade

```{r gerando function graf condutividade-eletrica, echo = TRUE}
boxplot_cond_elet <- function(dados = plan_wide_19902020, eixo_x = codigo, eixo_y = condutividade, titulo = "Condutividade elétrica"){
  ggplot2::ggplot(
    data = dados,
    aes(
      x = {{eixo_x}},
      y = {{eixo_y}}
    )
  )+
   annotate("rect",
            xmin = -Inf, xmax = Inf,
            ymin = 500, ymax = Inf,
            alpha = 1,
            fill="#eb5661")+ #classe 4
   annotate("rect",
            xmin = -Inf, xmax = Inf,
            ymin = 0, ymax = 500,
            alpha = 1,
            fill="#8dcdeb")+ #classe 1
   stat_summary(
     fun.data = f,
     geom = 'errorbar',
     width = 0.3,
     position = position_dodge(width = 0.65),
   )+
   stat_summary(
     fun.data = f,
     geom = "boxplot",
     width = 0.7,
     fill = '#F8F8FF',
     color = "black",
     outlier.shape = NA, #se deixar NA fica só o jitter, se não, deixa 1
   )+
      labs(title = titulo,
        x="Estação",
        y="µmhos/cm")+
   scale_y_continuous(expand = expansion(mult = c(0.01, 0.05)),
                      n.breaks = 8,
                      limits = c(
                        # min(plan_wide_19902020$condutividade, na.rm = TRUE),
                        5,
                        1000
                        # max(plan_wide_19902020$condutividade, na.rm = TRUE)
                      ),
                      labels = scales::number_format(accuracy = 1,
                                                     decimal.mark = ",",
                                                     big.mark = " "),
                      trans = "log10")+
    ggbeeswarm::geom_quasirandom(
     size = 1.2,
     alpha = .25,
     width = .07,
   )+
   scale_x_discrete(limits = c("87398500", 
                               "87398980", 
                               "87398900", 
                               "87398950", 
                               "87405500", 
                               "87406900", 
                               "87409900"),
                    labels = c("PM1", "PM2", "PM3", "PM4", "PM5", "PM6", "PM7")
   )+
   geom_smooth(method = "lm",
               se=FALSE, #se deixar TRUE gera o intervalo de confiança de 95%
               aes(group=1),
               alpha=.5,
               na.rm = TRUE,
               size = 1)+
   theme_grafs()
}
```

```{r gerando function ts_condutividade, echo = TRUE}
ts_condutividade <- function(dados = plan_wide_19902020, eixo_x = data_coleta, eixo_y = condutividade, titulo = "Condutividade elétrica"){
  dados %>%
    dplyr::filter(
      periodo == "1990-2000" | 
        periodo == "2000-2010" | 
        periodo == "2010-2020"
    ) %>%
    dplyr::select(ponto_monitoramento, condutividade, data_coleta, periodo) %>%
    ggplot2::ggplot(
      data = .,
      aes(
        x = {{eixo_x}},
        y = {{eixo_y}}
      )
    )+
    annotate("rect",
             xmin = periodo_inicial, xmax = periodo_final,
             ymin = 500, ymax = Inf,
             alpha = 1,
             fill="#eb5661")+ #classe 4
    annotate("rect",
             xmin = periodo_inicial, xmax = periodo_final,
             ymin = 0, ymax = 500,
             alpha = 1,
             fill="#8dcdeb")+ #classe 1
    labs(title = titulo,
        x=NULL,
        y="µmhos/cm")+
    geom_vline(
      xintercept = as.Date(c("2010-01-01", "2000-01-01"), "%Y-%m-%d"),
      color = "grey25",
      linetype = "dashed",
    )+
    geom_line(
      linewidth = 0.05,
      linetype = 9,
      # aes(color = codigo),
      na.rm = TRUE
    )+
    geom_point(
      size = 1,
      # aes(color = codigo),
      na.rm = TRUE
    )+
    scale_x_date(
      limits = as.Date(c(
        "1990-01-01", 
        "2021-01-01"
        # NA #pode usar NA também
      )),
      expand = c(0.0, 0.0),
      date_breaks = "5 years",
      minor_breaks = "1 year",
      date_labels = "%Y",
    )+
    facet_wrap(
      ~ponto_monitoramento,
      nrow = 4,
    )+
    theme_bw()+
    theme(
      plot.title = 
        element_text(
          hjust = 0.5,
          color = "black",
          size = 17),
      
      axis.title.x =
        element_text(
          color = "black",
          size = 15,
          angle = 0,),
      # element_blank(),
      axis.title.y = element_text(
        color = "black",
        size = 15,
        angle = 90),
      axis.text.x = element_text(
        color = "black",
        size = 13,
        angle = 0),
      axis.text.y = element_text(
        color = "black",
        size = 15,
        angle = 0),
      
      strip.background = element_rect(fill = "white",
                                      linetype = 1,
                                      size = 0.5,
                                      color = "black"),
      strip.text = element_text(size = 14),
      # panel.background = element_rect(fill = "white"),
      panel.spacing.x = unit(1, "lines"),
      
      plot.margin = margin(l = 5, r = 10,
                           b = 5, t = 5)
    )
}
```

# Parâmetros físico-químicos

### Oxigênio Dissolvido

```{r Gráfico OD facetted, echo = TRUE, warning=FALSE, message = FALSE, fig.cap="Oxigênio Dissolvido no período 1990-2020"}
(od <- plan_wide_19902020 %>% 
   boxplot_od(
     titulo = "Oxigênio Dissolvido no período 1990-2020",
   )+
   facet_wrap(~periodo)
)
```

```{r Gráfico OD periodo 1, echo = FALSE, warning=FALSE, message = FALSE, fig.cap="Oxigênio Dissolvido no período 1990-2000"}
(od_p1 <- plan_wide_19902020 %>% 
   filter(ano_coleta > "1990" &
            ano_coleta <= "2000") %>% 
   boxplot_od(
     titulo = "Oxigênio Dissolvido no período 1990-2000"
   )
)
```

```{r Gráfico OD periodo 2, echo = FALSE, warning=FALSE, message = FALSE}
(od_p2 <- plan_wide_19902020 %>% 
   filter(ano_coleta > "2000" &
            ano_coleta <= "2010") %>% 
   boxplot_od(
     titulo = "Oxigênio Dissolvido no período 2000-2010"
   )
)
```

```{r Gráfico OD periodo 3, echo = FALSE, warning=FALSE, message = FALSE}
(od_p3 <- plan_wide_19902020 %>% 
   filter(ano_coleta > "2010" &
            ano_coleta <= "2020") %>% 
   boxplot_od(
     titulo = "Oxigênio Dissolvido no período 2010-2020"
   )
)
```

```{r gráfico time-series OD, echo = TRUE, warning=FALSE, message=FALSE}
(od_overtime <- ts_od()+
   scale_y_continuous(
     expand = expansion(mult = c(0.05, 0.05)),
     n.breaks = 6,
     trans = scales::pseudo_log_trans(base=10),
     breaks = c(0, 2, 4, 8, 16),
   )
)
```

```{r Salvando OD, warning=FALSE, message = FALSE,}
ggsave("od.png",
       units = c("px"),
       width = 4500,
       height = 2993,
       plot = od,
       path = "./graficos",
       dpi = 300,
       type = "cairo")

ggsave("od_overtime.png",
       units = c("px"),
       width = 4500,
       height = 2993,
       plot = od_overtime,
       path = "./graficos",
       dpi = 300,
       type = "cairo")

ggsave("od_p1.png",
       plot = od_p1,
       path = "./graficos",
       dpi = 300,
       type = "cairo")

ggsave("od_p2.png",
       plot = od_p2,
       path = "./graficos",
       dpi = 300,
       type = "cairo")

ggsave("od_p3.png",
       plot = od_p3,
       path = "./graficos",
       dpi = 300,
       type = "cairo")
```

```{r Gráfico IQA OD periodo1, echo = FALSE, message=FALSE, warning=FALSE}
(iqaod_p1 <-ggplot(plan_wide_19902020 %>% 
                      filter(ano_coleta > "1990" &
                                ano_coleta <= "2000"),
                   aes(codigo,
                       iqa_od, na.rm = TRUE))+
    annotate("rect",
             xmin=-Inf,
             xmax=Inf,
             ymin=-Inf,
             ymax=19,
             alpha=1,
             fill="#ac5079")+ #>pior classe
    annotate("rect",
             xmin=-Inf,
             xmax=Inf,
             ymin=19,
             ymax=36,
             alpha=1,
             fill="#eb5661")+ #classe 4
    annotate("rect",
             xmin=-Inf,
             xmax=Inf,
             ymin=36,
             ymax=51,
             alpha=1,
             fill="#fcf7ab")+ #classe 3
    annotate("rect",
             xmin=-Inf,
             xmax=Inf,
             ymin=51,
             ymax=79,
             alpha=1,
             fill="#70c18c")+ #classe 2
    annotate("rect",
             xmin=-Inf,
             xmax=Inf,
             ymin=79,
             ymax=Inf,
             alpha=1,
             fill="#8dcdeb")+ #classe 1
   stat_summary(
     fun.data = f,
     geom = 'errorbar',
     width = 0.3,
     position = position_dodge(width = 0.65),
   )+
   stat_summary(
     fun.data = f,
     geom = "boxplot",
     width = 0.7,
     fill = '#F8F8FF',
     color = "black",
     outlier.shape = NA, #se deixar NA fica só o jitter, se não, deixa 1
   )+
   labs(title = "Variação do IQA para o parâmetro Oxigênio Dissolvido 1990-2000",
        x="Estação",
         y="")+
    ggbeeswarm::geom_quasirandom(
       size = 1.2,
       alpha = .25,
       width = .07,
    )+
    scale_x_discrete(limits = c("87398500", 
                                "87398980", 
                                "87398900", 
                                "87398950", 
                                "87405500", 
                                "87406900", 
                                "87409900"),
                     labels = c("PM1", "PM2", "PM3", "PM4", "PM5", "PM6", "PM7")
    )+
    scale_y_continuous(expand = expansion(mult = c(0,0)),
                       n.breaks = 6,
                       limits = c(-1,101))+
    geom_smooth(
       method = "lm",
       se=FALSE, #se deixar TRUE gera o intervalo de confiança de 95%
       aes(group=1),
       alpha=.5,
       na.rm = TRUE,
       linewidth = 1
    )+
    theme_grafs()
)
```

```{r Gráfico IQA OD periodo2, echo = FALSE, warning= FALSE, message = FALSE}
(iqaod_p2 <-ggplot(plan_wide_19902020 %>% 
                      filter(ano_coleta > "2000" &
                                ano_coleta <= "2010"),
                   aes(codigo,
                       iqa_od, na.rm = TRUE))+
    annotate("rect",
             xmin=-Inf,
             xmax=Inf,
             ymin=-Inf,
             ymax=19,
             alpha=1,
             fill="#ac5079")+ #>pior classe
    annotate("rect",
             xmin=-Inf,
             xmax=Inf,
             ymin=19,
             ymax=36,
             alpha=1,
             fill="#eb5661")+ #classe 4
    annotate("rect",
             xmin=-Inf,
             xmax=Inf,
             ymin=36,
             ymax=51,
             alpha=1,
             fill="#fcf7ab")+ #classe 3
    annotate("rect",
             xmin=-Inf,
             xmax=Inf,
             ymin=51,
             ymax=79,
             alpha=1,
             fill="#70c18c")+ #classe 2
    annotate("rect",
             xmin=-Inf,
             xmax=Inf,
             ymin=79,
             ymax=Inf,
             alpha=1,
             fill="#8dcdeb")+ #classe 1
    stat_boxplot(geom = 'errorbar',
                 width=0.3,
                 position = position_dodge(width = 0.65),
                 na.rm = TRUE)+
    geom_boxplot(fill='#F8F8FF',
                 color="black",
                 outlier.shape = NA, #se deixar NA fica só o jitter, se não, deixa 1
                 width= 0.7,
                 na.rm = TRUE)+
    labs(title = "Variação do IQA para o parâmetro Oxigênio Dissolvido 2000-2010",
         x="Estação",
         y="")+
    ggbeeswarm::geom_quasirandom(
       size = 1.2,
       alpha = .25,
       width = .07,
    )+
    scale_y_continuous(expand = expansion(mult = c(0,0)),
                       n.breaks = 6,
                       limits = c(-1,101))+
    scale_x_discrete(limits = c("87398500", 
                                "87398980", 
                                "87398900", 
                                "87398950", 
                                "87405500", 
                                "87406900", 
                                "87409900"),
                     labels = c("PM1", "PM2", "PM3", "PM4", "PM5", "PM6", "PM7")
    )+
    geom_smooth(
       method = "lm",
       se=FALSE, #se deixar TRUE gera o intervalo de confiança de 95%
       aes(group=1),
       alpha=.5,
       na.rm = TRUE,
       linewidth = 1
    )+
    theme_grafs()
)

```

```{r Gráfico IQA OD periodo3, echo = FALSE, warning=FALSE, message = FALSE}
(iqaod_p3 <-ggplot(plan_wide_19902020 %>% 
                      filter(ano_coleta > "2010" &
                                ano_coleta <= "2020"),
                   aes(codigo,
                       iqa_od, na.rm = TRUE))+
    annotate("rect",
             xmin=-Inf,
             xmax=Inf,
             ymin=-Inf,
             ymax=19,
             alpha=1,
             fill="#ac5079")+ #>pior classe
    annotate("rect",
             xmin=-Inf,
             xmax=Inf,
             ymin=19,
             ymax=36,
             alpha=1,
             fill="#eb5661")+ #classe 4
    annotate("rect",
             xmin=-Inf,
             xmax=Inf,
             ymin=36,
             ymax=51,
             alpha=1,
             fill="#fcf7ab")+ #classe 3
    annotate("rect",
             xmin=-Inf,
             xmax=Inf,
             ymin=51,
             ymax=79,
             alpha=1,
             fill="#70c18c")+ #classe 2
    annotate("rect",
             xmin=-Inf,
             xmax=Inf,
             ymin=79,
             ymax=Inf,
             alpha=1,
             fill="#8dcdeb")+ #classe 1
    stat_boxplot(geom = 'errorbar',
                 width=0.3,
                 position = position_dodge(width = 0.65),
                 na.rm = TRUE)+
    geom_boxplot(fill='#F8F8FF',
                 color="black",
                 outlier.shape = NA, #se deixar NA fica só o jitter, se não, deixa 1
                 width= 0.7,
                 na.rm = TRUE)+
    labs(title = "Variação do IQA para o parâmetro Oxigênio Dissolvido 2010-2020",
         x="Estação",
         y="")+
    ggbeeswarm::geom_quasirandom(
       size = 1.2,
       alpha = .25,
       width = .07,
    )+
    scale_y_continuous(expand = expansion(mult = c(0,0)),
                       n.breaks = 6,
                       limits = c(-1,101))+
    scale_x_discrete(limits = c("87398500", 
                                "87398980", 
                                "87398900", 
                                "87398950", 
                                "87405500", 
                                "87406900", 
                                "87409900"),
                     labels = c("PM1", "PM2", "PM3", "PM4", "PM5", "PM6", "PM7")
    )+
    geom_smooth(
       method = "lm",
       se=FALSE, #se deixar TRUE gera o intervalo de confiança de 95%
       aes(group=1),
       alpha=.5,
       na.rm = TRUE,
       linewidth = 1
    )+
    theme_grafs()
)
```

```{r Sumário OD, echo = TRUE, warning=FALSE, message = FALSE,}
# (sum_od_p1 <- plan_wide_19902020 %>%
#     select(ponto_monitoramento, oxigenio_dissolvido, ano_coleta) %>% 
#     filter(ano_coleta > "1990" &
#              ano_coleta <= "2000") %>% 
#    group_by(ponto_monitoramento) %>% 
#    # codigo == "87398500" <- "teste1"
#     # %>% 
#  summarize(
#        max = 
#          max(oxigenio_dissolvido, na.rm = TRUE),
#        p95 = 
#          quantile(oxigenio_dissolvido, 0.95, na.rm = TRUE),
#        p80 = 
#          quantile(oxigenio_dissolvido, 0.80, na.rm = TRUE),
#        median = 
#          median(oxigenio_dissolvido, na.rm = TRUE),
#        mean = 
#          mean(oxigenio_dissolvido, na.rm= TRUE),
#        p20 = 
#          quantile(oxigenio_dissolvido, 0.20, na.rm = TRUE),
#        p05 = 
#          quantile(oxigenio_dissolvido, 0.05, na.rm = TRUE),
#        min = 
#          min(oxigenio_dissolvido, na.rm = TRUE),
#        n = 
#          length(oxigenio_dissolvido)
#  ) %>% 
#     pivot_longer(
#        !ponto_monitoramento,
#        names_to = "par",
#        values_to = "valor"
#     ) %>% 
#     pivot_wider(names_from = ponto_monitoramento,
#                 values_from = valor) 
#  # %>% 
#  # rename(
#  #   "PM1" = "87398500",
#  #   "PM2" = "87398900",
#  #   "PM3" = "87398950",
#  #   "PM4" = "87398980",
#  #   "PM5" = "87405500",
#  #   "PM6" = "87406900",
#  #   "PM7" = "87409900"
#  # ) 
# )
sum_od_p1 <- ExpCustomStat(
  plan_wide_19902020 %>% 
    filter(
      periodo == "1990-2000"
    ), 
  Cvar = c("ponto_monitoramento"), 
  Nvar = c("oxigenio_dissolvido"),
  stat = c('max', 'p0.95', 'p0.8', 'median', 'mean', 'p0.2', 'p0.05', 'min', "count"), 
  gpby = TRUE) %>% 
  arrange(ponto_monitoramento) %>% 
  dplyr::select(-Attribute) %>% 
  pivot_longer(
    !ponto_monitoramento,
    names_to = "par",
    values_to = "valor"
  ) %>% 
  pivot_wider(names_from = ponto_monitoramento,
              values_from = valor)  


sum_od_p2 <- ExpCustomStat(
  plan_wide_19902020 %>% 
    filter(
      periodo == "2000-2010"
    ), 
  Cvar = c("ponto_monitoramento"), 
  Nvar = c("oxigenio_dissolvido"),
  stat = c('max', 'p0.95', 'p0.8', 'median', 'mean', 'p0.2', 'p0.05', 'min', "count"), 
  gpby = TRUE) %>% 
  arrange(ponto_monitoramento) %>% 
  dplyr::select(-Attribute) %>%
  pivot_longer(
    !ponto_monitoramento,
    names_to = "par",
    values_to = "valor"
  ) %>% 
  pivot_wider(names_from = ponto_monitoramento,
              values_from = valor)  

sum_od_p3 <- ExpCustomStat(
  plan_wide_19902020 %>% 
    filter(
      periodo == "2010-2020"
    ), 
  Cvar = c("ponto_monitoramento"), 
  Nvar = c("oxigenio_dissolvido"),
  stat = c('max', 'p0.95', 'p0.8', 'median', 'mean', 'p0.2', 'p0.05', 'min', "count"), 
  gpby = TRUE) %>% 
  arrange(ponto_monitoramento) %>% 
  dplyr::select(-Attribute) %>%
  pivot_longer(
    !ponto_monitoramento,
    names_to = "par",
    values_to = "valor"
  ) %>% 
  pivot_wider(names_from = ponto_monitoramento,
              values_from = valor)
```

### Demanda Bioquímica de Oxigênio {#sec-dbo}

```{r graf_dbo_facet, echo=TRUE, fig.cap="Demanda Bioquímica de Oxigênio no período 1990-2020", message=FALSE, warning=FALSE}
(dbo <- plan_wide_19902020 %>% 
  boxplot_dbo(
    titulo = "Demanda Bioquímica de Oxigênio no período 1990-2020",
  )+
  facet_wrap(~periodo)
 )
```

```{r Gráfico DBO período1, echo = FALSE, warning = FALSE, message = FALSE}
(dbo_p1 <- plan_wide_19902020 %>% 
   filter(ano_coleta>"1990" &
            ano_coleta<="2000") %>% 
   boxplot_dbo(
    titulo = "Demanda Bioquímica de Oxigênio no período 1990-2000",
  )
)
```

```{r Gráfico DBO período2, echo = FALSE, warning = FALSE, message = FALSE}
(dbo_p2 <- plan_wide_19902020 %>% 
   filter(ano_coleta>"2000" &
            ano_coleta<="2010") %>% 
   boxplot_dbo(
    titulo = "Demanda Bioquímica de Oxigênio no período 2000-2010",
  )
)
```

```{r Gráfico DBO período3, echo = FALSE, warning = FALSE, message = FALSE}
(dbo_p3 <- plan_wide_19902020 %>% 
   filter(ano_coleta > "2010" &
          ano_coleta <= "2020") %>% 
   boxplot_dbo(
    titulo = "Demanda Bioquímica de Oxigênio no período 2010-2020",
  )
)
```

```{r gráfico time-series dbo, echo=TRUE, warning=FALSE, message=FALSE}
(dbo_overtime <- ts_dbo()+
  scale_y_continuous(
     expand = expansion(mult = c(0.05, 0.05)),
     breaks = c(0, 1, 3, 5, 10, 20, 40, 60),
     # n.breaks = 6,
     trans = scales::pseudo_log_trans(base=10),
   )
 )
```

```{r Gráfico IQA DBO periodo1, echo = FALSE, warning = FALSE, message = FALSE}
(iqa_dbo1<-ggplot(plan_wide_19902020 %>% 
                    filter(ano_coleta>"1990" &
                             ano_coleta<="2000"),
                  aes(codigo,
                      iqa_dbo))+
   annotate("rect",
            xmin=-Inf,
            xmax=Inf,
            ymin=-Inf,
            ymax=19,
            alpha=1,
            fill="#ac5079")+ #>pior classe
   annotate("rect",
            xmin=-Inf,
            xmax=Inf,
            ymin=19,
            ymax=36,
            alpha=1,
            fill="#eb5661")+ #classe 4
   annotate("rect",
            xmin=-Inf,
            xmax=Inf,
            ymin=36,
            ymax=51,
            alpha=1,
            fill="#fcf7ab")+ #classe 3
   annotate("rect",
            xmin=-Inf,
            xmax=Inf,
            ymin=51,
            ymax=79,
            alpha=1,
            fill="#70c18c")+ #classe 2
   annotate("rect",
            xmin=-Inf,
            xmax=Inf,
            ymin=79,
            ymax=Inf,
            alpha=1,
            fill="#8dcdeb")+ #classe 1))
   stat_boxplot(geom = 'errorbar',
                width=0.3,
                position = position_dodge(width = 0.65),
                na.rm = TRUE)+
   geom_boxplot(fill='#F8F8FF',
                color="black",
                outlier.shape = NA, #se deixar NA fica só o jitter, se não, deixa 1
                width= 0.7)+
   labs(title = "Variação do IQA para o parâmetro DBO 1990-2020",
        x="Estação",
        y="mg/L")+
   ggbeeswarm::geom_quasirandom(
     size = 1.2,
     alpha = .25,
     width = .07,
   )+
   scale_y_continuous(expand = expansion(mult = c(0,0)),
                      n.breaks = 6,
                      limits = c(-1,101))+
    scale_x_discrete(limits = c("87398500", 
                                "87398980", 
                                "87398900", 
                                "87398950", 
                                "87405500", 
                                "87406900", 
                                "87409900"),
                     labels = c("PM1", "PM2", "PM3", "PM4", "PM5", "PM6", "PM7")
    )+
    geom_smooth(method = "lm",
                se=FALSE, #se deixar TRUE gera o intervalo de confiança de 95%
                aes(group=1),
                alpha=.5,
                na.rm = TRUE,
                linewidth = 1)+
    theme_grafs()
)
```

```{r Gráfico IQA DBO periodo2, echo = FALSE, warning = FALSE, message = FALSE}
(iqa_dbo2<-ggplot(plan_wide_19902020%>% 
                     filter(ano_coleta>"2000" &
                               ano_coleta<="2010"),
                  aes(codigo,
                      iqa_dbo))+
    annotate("rect",
             xmin=-Inf,
             xmax=Inf,
             ymin=-Inf,
             ymax=19,
             alpha=1,
             fill="#ac5079")+ #>pior classe
    annotate("rect",
             xmin=-Inf,
             xmax=Inf,
             ymin=19,
             ymax=36,
             alpha=1,
             fill="#eb5661")+ #classe 4
    annotate("rect",
             xmin=-Inf,
             xmax=Inf,
             ymin=36,
             ymax=51,
             alpha=1,
             fill="#fcf7ab")+ #classe 3
    annotate("rect",
             xmin=-Inf,
             xmax=Inf,
             ymin=51,
             ymax=79,
             alpha=1,
             fill="#70c18c")+ #classe 2
    annotate("rect",
             xmin=-Inf,
             xmax=Inf,
             ymin=79,
             ymax=Inf,
             alpha=1,
             fill="#8dcdeb")+ #classe 1))
    stat_boxplot(geom = 'errorbar',
                 width=0.3,
                 position = position_dodge(width = 0.65),
                 na.rm = TRUE)+
    geom_boxplot(fill='#F8F8FF',
                 color="black",
                 outlier.shape = NA, #se deixar NA fica só o jitter, se não, deixa 1
                 width= 0.7)+
    labs(title = "Variação do IQA para o parâmetro DBO 2000-2010",
         x="Estação",
         y="mg/L")+
    ggbeeswarm::geom_quasirandom(
       size = 1.2,
       alpha = .25,
       width = .07,
    )+
    scale_y_continuous(expand = expansion(mult = c(0,0)),
                       n.breaks = 6,
                       limits = c(-1,101))+
    scale_x_discrete(limits = c("87398500", 
                                "87398980", 
                                "87398900", 
                                "87398950", 
                                "87405500", 
                                "87406900", 
                                "87409900"),
                     labels = c("PM1", "PM2", "PM3", "PM4", "PM5", "PM6", "PM7")
    )+
    geom_smooth(method = "lm",
                se=FALSE, #se deixar TRUE gera o intervalo de confiança de 95%
                aes(group=1),
                alpha=.5,
                na.rm = TRUE,
                linewidth = 1)+
    theme_grafs()
)
```

```{r Gráfico IQA DBO periodo3, echo = FALSE, warning = FALSE, message = FALSE}
(iqa_dbo3<-ggplot(plan_wide_19902020%>% 
                     filter(ano_coleta>"2010" &
                               ano_coleta<="2020"),
                  aes(codigo,
                      iqa_dbo))+
    annotate("rect",
             xmin=-Inf,
             xmax=Inf,
             ymin=-Inf,
             ymax=19,
             alpha=1,
             fill="#ac5079")+ #>pior classe
    annotate("rect",
             xmin=-Inf,
             xmax=Inf,
             ymin=19,
             ymax=36,
             alpha=1,
             fill="#eb5661")+ #classe 4
    annotate("rect",
             xmin=-Inf,
             xmax=Inf,
             ymin=36,
             ymax=51,
             alpha=1,
             fill="#fcf7ab")+ #classe 3
    annotate("rect",
             xmin=-Inf,
             xmax=Inf,
             ymin=51,
             ymax=79,
             alpha=1,
             fill="#70c18c")+ #classe 2
    annotate("rect",
             xmin=-Inf,
             xmax=Inf,
             ymin=79,
             ymax=Inf,
             alpha=1,
             fill="#8dcdeb")+ #classe 1))
    stat_boxplot(geom = 'errorbar',
                 width=0.3,
                 position = position_dodge(width = 0.65),
                 na.rm = TRUE)+
    geom_boxplot(fill='#F8F8FF',
                 color="black",
                 outlier.shape = NA, #se deixar NA fica só o jitter, se não, deixa 1
                 width= 0.7)+
    labs(title = "Variação do IQA para o parâmetro DBO 2010-2020",
         x="Estação",
         y="mg/L")+
    ggbeeswarm::geom_quasirandom(
       size = 1.2,
       alpha = .25,
       width = .07,
    )+
    scale_y_continuous(expand = expansion(mult = c(0,0)),
                       n.breaks = 6,
                       limits = c(-1,101))+
   scale_x_discrete(limits = c("87398500", 
                               "87398980", 
                               "87398900", 
                               "87398950", 
                               "87405500", 
                               "87406900", 
                               "87409900"),
                    labels = c("PM1", "PM2", "PM3", "PM4", "PM5", "PM6", "PM7")
   )+
        geom_smooth(method = "lm",
                se=FALSE, #se deixar TRUE gera o intervalo de confiança de 95%
                aes(group=1),
                alpha=.5,
                na.rm = TRUE,
                linewidth = 1)+
    theme_grafs()
)
```

```{r Sumário DBO, warning=FALSE, message = FALSE,}
sum_dbo_p1 <- ExpCustomStat(
  plan_wide_19902020 %>% 
    filter(
      periodo == "1990-2000"
    ), 
  Cvar = c("ponto_monitoramento"), 
  Nvar = c("dbo"),
  stat = c('max', 'p0.95', 'p0.8', 'median', 'mean', 'p0.2', 'p0.05', 'min', "count"), 
  gpby = TRUE) %>% 
  arrange(ponto_monitoramento) %>% 
  dplyr::select(-Attribute) %>%
  pivot_longer(
    !ponto_monitoramento,
    names_to = "par",
    values_to = "valor"
  ) %>% 
  pivot_wider(names_from = ponto_monitoramento,
              values_from = valor)

sum_dbo_p2 <- ExpCustomStat(
  plan_wide_19902020 %>% 
    filter(
      periodo == "2000-2010"
    ), 
  Cvar = c("ponto_monitoramento"), 
  Nvar = c("dbo"),
  stat = c('max', 'p0.95', 'p0.8', 'median', 'mean', 'p0.2', 'p0.05', 'min', "count"), 
  gpby = TRUE) %>% 
  arrange(ponto_monitoramento) %>% 
  dplyr::select(-Attribute) %>%
  pivot_longer(
    !ponto_monitoramento,
    names_to = "par",
    values_to = "valor"
  ) %>% 
  pivot_wider(names_from = ponto_monitoramento,
              values_from = valor)

sum_dbo_p3 <- ExpCustomStat(
  plan_wide_19902020 %>% 
    filter(
      periodo == "2010-2020"
    ), 
  Cvar = c("ponto_monitoramento"), 
  Nvar = c("dbo"),
  stat = c('max', 'p0.95', 'p0.8', 'median', 'mean', 'p0.2', 'p0.05', 'min', "count"), 
  gpby = TRUE) %>% 
  arrange(ponto_monitoramento) %>% 
  dplyr::select(-Attribute) %>%
  pivot_longer(
    !ponto_monitoramento,
    names_to = "par",
    values_to = "valor"
  ) %>% 
  pivot_wider(names_from = ponto_monitoramento,
              values_from = valor)
```

```{r Salvando DBO, warning=FALSE, message = FALSE,}
ggsave("dbo.png",
       units = c("px"),
       width = 4500,
       height = 2993,
       plot = dbo,
       path = "./graficos",
       dpi = 300,
       type = "cairo")

ggsave("dbo_overtime.png",
       units = c("px"),
       width = 4500,
       height = 2993,
       plot = dbo_overtime,
       path = "./graficos",
       dpi = 300,
       type = "cairo")

ggsave("dbo_p1.png",
       plot = dbo_p1,
       path = "./graficos",
       dpi = 300,
       type = "cairo")

ggsave("dbo_p2.png",
       plot = dbo_p2,
       path = "./graficos",
       dpi = 300,
       type = "cairo")

ggsave("dbo_p3.png",
       plot = dbo_p3,
       path = "./graficos",
       dpi = 300,
       type = "cairo")
```

### Fósforo total

```{r Gráfico fósforo total facetted, echo = TRUE, fig.cap="Fósforo total no período 1990-2020"}
(ptot <- plan_wide_19902020 %>% 
   boxplot_ptot(
     titulo = "Fósforo total no período 1990-2020",
   )+
   facet_wrap(~periodo)
)
```

```{r gráfico time-series ptot, echo=TRUE, warning=FALSE, message=FALSE}
(ptot_overview <- ts_ptot()+
   scale_y_continuous(expand = expansion(mult = c(0.03,0.03)),
                      n.breaks = 5,
                      limits = c(min(plan_wide_19902020$fosforo_total, na.rm = TRUE)/2,
                                 max(plan_wide_19902020$fosforo_total, na.rm = TRUE)*3),
                      trans = "log10",
                      labels = scales::number_format(accuracy = .001,
                                                     decimal.mark = ",",
                                                     big.mark = " ")
   )
)
```

```{r Gráfico Fósforo total periodo1, echo = FALSE, warning = FALSE, message = FALSE}
(ptot_p1 <- plan_wide_19902020%>% 
   filter(ano_coleta>"1990" &
            ano_coleta<="2000") %>% 
   boxplot_ptot(
     titulo = "Fósforo total no período 1990-2000",
   )
)
```

```{r Gráfico Fósforo total periodo2, echo = FALSE, warning = FALSE, message = FALSE}
(ptot_p2 <- plan_wide_19902020%>% 
   filter(ano_coleta>"2000" &
            ano_coleta<="2010") %>% 
   boxplot_ptot(
     titulo = "Fósforo total no período 2000-2010",
   )
)
```

```{r Gráfico Fósforo total periodo3, echo = FALSE, warning = FALSE, message = FALSE}
(ptot_p3 <- plan_wide_19902020 %>% 
   filter(ano_coleta>"2010" &
            ano_coleta<="2020") %>% 
   boxplot_ptot(
     titulo = "Fósforo total no período 2010-2020",
   )
)
```

```{r Sumário Fósforo total, warning=FALSE, message = FALSE,}
sum_ptot_p1 <- ExpCustomStat(
  plan_wide_19902020 %>% 
    filter(
      periodo == "1990-2000"
    ), 
  Cvar = c("ponto_monitoramento"), 
  Nvar = c("fosforo_total"),
  stat = c('max', 'p0.95', 'p0.8', 'median', 'mean', 'p0.2', 'p0.05', 'min', "count"), 
  gpby = TRUE) %>% 
  arrange(ponto_monitoramento) %>% 
  dplyr::select(-Attribute) %>%
  pivot_longer(
    !ponto_monitoramento,
    names_to = "par",
    values_to = "valor"
  ) %>% 
  pivot_wider(names_from = ponto_monitoramento,
              values_from = valor)

sum_ptot_p2 <- ExpCustomStat(
  plan_wide_19902020 %>% 
    filter(
      periodo == "2000-2010"
    ), 
  Cvar = c("ponto_monitoramento"), 
  Nvar = c("fosforo_total"),
  stat = c('max', 'p0.95', 'p0.8', 'median', 'mean', 'p0.2', 'p0.05', 'min', "count"), 
  gpby = TRUE) %>% 
  arrange(ponto_monitoramento) %>% 
  dplyr::select(-Attribute) %>%
  pivot_longer(
    !ponto_monitoramento,
    names_to = "par",
    values_to = "valor"
  ) %>% 
  pivot_wider(names_from = ponto_monitoramento,
              values_from = valor)

sum_ptot_p3 <- ExpCustomStat(
  plan_wide_19902020 %>% 
    filter(
      periodo == "2010-2020"
    ), 
  Cvar = c("ponto_monitoramento"), 
  Nvar = c("fosforo_total"),
  stat = c('max', 'p0.95', 'p0.8', 'median', 'mean', 'p0.2', 'p0.05', 'min', "count"), 
  gpby = TRUE) %>% 
  arrange(ponto_monitoramento) %>% 
  dplyr::select(-Attribute) %>%
  pivot_longer(
    !ponto_monitoramento,
    names_to = "par",
    values_to = "valor"
  ) %>% 
  pivot_wider(names_from = ponto_monitoramento,
              values_from = valor)
```

```{r Salvando Ptot, warning=FALSE, message = FALSE,}
ggsave("ptot.png",
       units = c("px"),
       width = 4500,
       height = 2993,
       plot = ptot,
       path = "./graficos",
       dpi = 300,
       type = "cairo")

ggsave("ptot_overview.png",
       units = c("px"),
       width = 4500,
       height = 2993,
       plot = ptot_overview,
       path = "./graficos",
       dpi = 300,
       type = "cairo")

ggsave("ptot_p1.png",
       plot = ptot_p1,
       path = "./graficos",
       dpi = 300,
       type = "cairo")

ggsave("ptot_p2.png",
       plot = ptot_p2,
       path = "./graficos",
       dpi = 300,
       type = "cairo")

ggsave("ptot_p3.png",
       plot = ptot_p3,
       path = "./graficos",
       dpi = 300,
       type = "cairo")
```

### Escherichia coli

```{r Gráfico Ecoli facetted, fig.cap="Escherichia-coli-gravataí no período 1990-2020", warning = FALSE, message = FALSE}
(ecoli <- boxplot_ecoli(
  titulo = "*Escherichia coli* no período 1990-2020"
)+
  # scale_y_log10(
  #   breaks = trans_breaks("log10", function(x) 10^x),
  #   labels = trans_format("log10", math_format(10^.x)),
  #   expand = expansion(mult = c(0.05, 0.25)),
  #   n.breaks = 9,
  # )+
  # annotation_logticks(sides = "l",
  #                     size = 0.01,
  #                     outside = TRUE)+
  # coord_cartesian(clip = "off")+
  facet_wrap(~periodo)
  # theme(
  #   panel.spacing.x = unit(0.7, "lines"),
  #   axis.ticks.length.y = unit(0.3, "cm"),
  # )
)
```

```{r Gráfico Ecoli periodo1, warning = FALSE, message = FALSE}
(ecoli_p1 <- plan_wide_19902020 %>% 
   filter(periodo == "1990-2000") %>% 
   boxplot_ecoli(
     titulo = "*Escherichia coli* no período 1990-2000"
   )+
  scale_y_log10(
    breaks = trans_breaks("log10", function(x) 10^x),
    labels = trans_format("log10", math_format(10^.x)),
    expand = expansion(mult = c(0.05, 0.25)),
    n.breaks = 9,
  )+
  annotation_logticks(sides = "l",
                      size = 0.01,
                      outside = TRUE)+
  coord_cartesian(clip = "off")+
  # facet_wrap(~periodo)+
  theme(
    panel.spacing.x = unit(0.7, "lines"),
    axis.ticks.length.y = unit(0.3, "cm"),
  )
)
```

```{r Gráfico Ecoli periodo2, warning = FALSE, message = FALSE}
(ecoli_p2 <- ggplot(plan_wide_19902020 %>% 
                       filter(ano_coleta>"2000" &
                                 ano_coleta<="2010"),
                    aes(codigo,
                        escherichia_coli))+
    annotate("rect",
             xmin=-Inf,
             xmax=Inf,
             ymin=3200,
             ymax=Inf,
             alpha=1,
             fill="#ac5079")+ #>pior classe
    annotate("rect",
             xmin=-Inf,
             xmax=Inf,
             ymin=800,
             ymax=3200,
             alpha=1,
             fill="#fcf7ab")+ #classe 3
    annotate("rect",
             xmin=-Inf,
             xmax=Inf,
             ymin=160,
             ymax=800,
             alpha=1,
             fill="#70c18c")+ #classe 2
    annotate("rect",
             xmin=-Inf,
             xmax=Inf,
             ymin=0,
             ymax=160,
             alpha=1,
             fill="#8dcdeb")+ #classe 1
    stat_boxplot(geom = 'errorbar',
                 width=0.3,
                 position = position_dodge(width = 0.65))+
    geom_boxplot(fill='#F8F8FF',
                 color="black",
                 outlier.shape = NA, #se deixar NA fica só o jitter, se não, deixa 1
                 width= 0.7)+
    labs(title = "Escherichia coli no período 2000-2010",
         x="Estação",
         y="NMP/100mL")+
    scale_y_continuous(expand = expansion(mult = c(0.01, 0.01)),
                       n.breaks = 9,
                       limits = c(min(plan_wide_19902020$escherichia_coli, na.rm = TRUE),
                                  max(plan_wide_19902020$escherichia_coli, na.rm = TRUE)),
                       trans = "log10",
                       labels = scales::number_format(accuracy = 1,
                                                      decimal.mark = ",",
                                                      big.mark = " "))+
   ggbeeswarm::geom_quasirandom(
     size = 1.2,
     alpha = .25,
     width = .07,
   )+
   scale_x_discrete(limits = c("87398500", 
                               "87398980", 
                               "87398900", 
                               "87398950", 
                               "87405500", 
                               "87406900", 
                               "87409900"),
                    labels = c("PM1", "PM2", "PM3", "PM4", "PM5", "PM6", "PM7")
   )+
    geom_smooth(method = "lm",
                se=FALSE, #se deixar TRUE gera o intervalo de confiança de 95%
                aes(group=1),
                alpha=.5,
                na.rm = TRUE,
                linewidth = 1)+
    theme_grafs()
)
```

```{r Gráfico Ecoli periodo3, warning = FALSE, message = FALSE}
(ecoli_p3 <- ggplot(plan_wide_19902020 %>% 
                       filter(ano_coleta>"2010" &
                                 ano_coleta<="2020"),
                    aes(codigo,
                        escherichia_coli))+
    annotate("rect",
             xmin=-Inf,
             xmax=Inf,
             ymin=3200,
             ymax=Inf,
             alpha=1,
             fill="#ac5079")+ #>pior classe
    annotate("rect",
             xmin=-Inf,
             xmax=Inf,
             ymin=800,
             ymax=3200,
             alpha=1,
             fill="#fcf7ab")+ #classe 3
    annotate("rect",
             xmin=-Inf,
             xmax=Inf,
             ymin=160,
             ymax=800,
             alpha=1,
             fill="#70c18c")+ #classe 2
    annotate("rect",
             xmin=-Inf,
             xmax=Inf,
             ymin=0,
             ymax=160,
             alpha=1,
             fill="#8dcdeb")+ #classe 1
    stat_boxplot(geom = 'errorbar',
                 width=0.3,
                 position = position_dodge(width = 0.65))+
    geom_boxplot(fill='#F8F8FF',
                 color="black",
                 outlier.shape = NA, #se deixar NA fica só o jitter, se não, deixa 1
                 width= 0.7)+
    labs(title = "Escherichia coli no período 2010-2020",
         x="Estação",
         y="NMP/100mL")+
    scale_y_continuous(expand = expansion(mult = c(0.01, 0.01)),
                       n.breaks = 9,
                       limits = c(min(plan_wide_19902020$escherichia_coli, na.rm = TRUE),
                                  max(plan_wide_19902020$escherichia_coli, na.rm = TRUE)),
                       trans = "log10",
                       labels = scales::number_format(accuracy = 1,
                                                      decimal.mark = ",",
                                                      big.mark = " "))+
    ggbeeswarm::geom_quasirandom(
     size = 1.2,
     alpha = .25,
     width = .07,
   )+
   scale_x_discrete(limits = c("87398500", 
                               "87398980", 
                               "87398900", 
                               "87398950", 
                               "87405500", 
                               "87406900", 
                               "87409900"),
                    labels = c("PM1", "PM2", "PM3", "PM4", "PM5", "PM6", "PM7")
   )+
    geom_smooth(method = "lm",
                se=FALSE, #se deixar TRUE gera o intervalo de confiança de 95%
                aes(group=1),
                alpha=.5,
                na.rm = TRUE,
                linewidth = 1)+
    theme_grafs()
)
```

```{r gráfico time-series ecoli, echo=TRUE, warning=FALSE, message=FALSE}
(ecoli_overview <- ts_ecoli()+
  # geom_vline(
  #    xintercept = as.Date(c("2002-01-01", "2003-01-01"), "%Y-%m-%d"),
  #    color = "red",
  #    linetype = "dashed",
  # )+
  scale_y_log10(
      breaks = trans_breaks("log10", function(x) 10^x),
      labels = trans_format("log10", math_format(10^.x)),
      expand = expansion(mult = c(0.05, 0.25)),
      n.breaks = 9,
    )+
   geom_smooth(
     method = "lm",
     se = FALSE,
     linewidth = 0.7,
   )
 )
```

```{r Sumário Ecoli, warning=FALSE, message = FALSE,}
sum_ecoli_p1 <- ExpCustomStat(
  plan_wide_19902020 %>% 
    filter(
      periodo == "1990-2000"
    ), 
  Cvar = c("ponto_monitoramento"), 
  Nvar = c("escherichia_coli"),
  stat = c('max', 'p0.95', 'p0.8', 'median', 'mean', 'p0.2', 'p0.05', 'min', "count"), 
  gpby = TRUE) %>% 
  arrange(ponto_monitoramento) %>% 
  dplyr::select(-Attribute) %>%
  pivot_longer(
    !ponto_monitoramento,
    names_to = "par",
    values_to = "valor"
  ) %>% 
  pivot_wider(names_from = ponto_monitoramento,
              values_from = valor)

sum_ecoli_p2 <- ExpCustomStat(
  plan_wide_19902020 %>% 
    filter(
      periodo == "2000-2010"
    ), 
  Cvar = c("ponto_monitoramento"), 
  Nvar = c("escherichia_coli"),
  stat = c('max', 'p0.95', 'p0.8', 'median', 'mean', 'p0.2', 'p0.05', 'min', "count"), 
  gpby = TRUE) %>% 
  arrange(ponto_monitoramento) %>% 
  dplyr::select(-Attribute) %>% 
  pivot_longer(
    !ponto_monitoramento,
    names_to = "par",
    values_to = "valor"
  ) %>% 
  pivot_wider(names_from = ponto_monitoramento,
              values_from = valor)

sum_ecoli_p3 <- ExpCustomStat(
  plan_wide_19902020 %>% 
    filter(
      periodo == "2010-2020"
    ), 
  Cvar = c("ponto_monitoramento"), 
  Nvar = c("escherichia_coli"),
  stat = c('max', 'p0.95', 'p0.8', 'median', 'mean', 'p0.2', 'p0.05', 'min', "count"), 
  gpby = TRUE) %>% 
  arrange(ponto_monitoramento) %>% 
  dplyr::select(-Attribute) %>%
  pivot_longer(
    !ponto_monitoramento,
    names_to = "par",
    values_to = "valor"
  ) %>% 
  pivot_wider(names_from = ponto_monitoramento,
              values_from = valor)
```

```{r Salvando ecoli, warning=FALSE, message = FALSE,}
ggsave("ecoli.png",
       plot = ecoli,
       path = "./graficos",
       dpi = 300,
       type = "cairo")

ggsave("ecoli_overview.png",
       plot = ecoli_overview,
       path = "./graficos",
       dpi = 300,
       type = "cairo")

ggsave("ecoli_p1.png",
       plot = ecoli_p1,
       path = "./graficos",
       dpi = 300,
       type = "cairo")

ggsave("ecoli_p2.png",
       plot = ecoli_p2,
       path = "./graficos",
       dpi = 300,
       type = "cairo")

ggsave("ecoli_p3.png",
       plot = ecoli_p3,
       path = "./graficos",
       dpi = 300,
       type = "cairo")
```

### Nitrogênio amoniacal

```{r Gráfico Nitrogênio total facetted, fig.cap="nitrogenio-gravataí no período 1990-2020", warning = FALSE, message = FALSE}
(namon <- plan_wide_19902020 %>% 
  boxplot_namon(
    eixo_y = nitrogenio_amoniacal,
    titulo = "Nitrogênio Amoniacal no período 1990-2020"
    )+
  facet_wrap(~periodo)
 )
```

```{r Gráfico Nitrogênio line, warning = FALSE, message = FALSE}
(nitro_overtime <- ts_nitro()+
  scale_y_continuous(
    expand = expansion(mult = c(0.0, 0.0)),
    n.breaks = 6,
    limits = c(min(plan_wide_19902020$nitrogenio_amoniacal, na.rm = TRUE)/3,
               max(plan_wide_19902020$nitrogenio_amoniacal, na.rm = TRUE)*5),
    trans = "log10",
    labels = scales::number_format(accuracy = .001,
                                   decimal.mark = ",",
                                   big.mark = " "))
 )
```

```{r Gráfico Nitrogênio total periodo1, warning = FALSE, message = FALSE}
(namon_p1 <- plan_wide_19902020 %>% 
   filter(ano_coleta>"1990" &
            ano_coleta<="2000") %>% 
   boxplot_namon(
     titulo = "Nitrogênio Amoniacal no período 1990-2000"
   )
 )
```

```{r Gráfico Nitrogênio total periodo2, warning = FALSE, message = FALSE}
(namon_p2 <- plan_wide_19902020 %>% 
   filter(ano_coleta>"2000" &
            ano_coleta<="2010") %>% 
   boxplot_namon(
     titulo = "Nitrogênio Amoniacal no período 2000-2010"
   )
 )
```

```{r Gráfico Nitrogênio total periodo3, warning = FALSE, message = FALSE}
(namon_p3 <- plan_wide_19902020 %>% 
   filter(ano_coleta>"2010" &
            ano_coleta<="2020") %>% 
   boxplot_namon(
     titulo = "Nitrogênio Amoniacal no período 2010-2020"
   )
 )
```

```{r Sumário Nitrogênio total, warning=FALSE, message = FALSE,}
(sum_namon_p1 <- plan_wide_19902020 %>%
   dplyr::select(codigo, nitrogenio_amoniacal, ano_coleta) %>% 
   filter(ano_coleta>"1990" &
            ano_coleta<="2000") %>% 
   group_by(codigo) %>% 
   summarize(
     min = 
       min(nitrogenio_amoniacal, 
           na.rm = TRUE),
     q1 = 
       quantile(nitrogenio_amoniacal, 0.25, 
                na.rm = TRUE),
     median = 
       median(nitrogenio_amoniacal, 
              na.rm = TRUE),
     mean = 
       mean(nitrogenio_amoniacal, 
            na.rm= TRUE),
     q3 = 
       quantile(nitrogenio_amoniacal, 0.75, 
                na.rm = TRUE),
     max = 
       max(nitrogenio_amoniacal, 
           na.rm = TRUE),
      n = 
       length(nitrogenio_amoniacal)
   )
)

(sum_namon_p2 <- plan_wide_19902020 %>%
    dplyr::select(codigo, nitrogenio_amoniacal, ano_coleta) %>% 
    filter(ano_coleta>"2000" &
             ano_coleta<="2010") %>% 
    group_by(codigo) %>% 
    summarize(
      min = 
        min(nitrogenio_amoniacal, 
            na.rm = TRUE),
      q1 = 
        quantile(nitrogenio_amoniacal, 0.25, 
                 na.rm = TRUE),
      median = 
        median(nitrogenio_amoniacal, 
               na.rm = TRUE),
      mean = 
        mean(nitrogenio_amoniacal, 
             na.rm= TRUE),
      q3 = 
        quantile(nitrogenio_amoniacal, 0.75, 
                 na.rm = TRUE),
      max = 
        max(nitrogenio_amoniacal, 
            na.rm = TRUE))
)

(sum_namon_p3 <- plan_wide_19902020 %>%
    dplyr::select(codigo, nitrogenio_amoniacal, ano_coleta) %>% 
    filter(ano_coleta>"2010" &
             ano_coleta<="2020") %>% 
    group_by(codigo) %>% 
    summarize(
      min = 
        min(nitrogenio_amoniacal, 
            na.rm = TRUE),
      q1 = 
        quantile(nitrogenio_amoniacal, 0.25, 
                 na.rm = TRUE),
      median = 
        median(nitrogenio_amoniacal, 
               na.rm = TRUE),
      mean = 
        mean(nitrogenio_amoniacal, 
             na.rm= TRUE),
      q3 = 
        quantile(nitrogenio_amoniacal, 0.75, 
                 na.rm = TRUE),
      max = 
        max(nitrogenio_amoniacal, 
            na.rm = TRUE))
)
```

```{r Salvando namon, warning=FALSE, message = FALSE,}
ggsave("namon.png",
       units = c("px"),
       width = 4500,
       height = 2993,
       plot = namon,
       path = "./graficos",
       dpi = 300,
       type = "cairo")

ggsave("namon_p1.png",
       plot = namon_p1,
       path = "./graficos",
       dpi = 300,
       type = "cairo")

ggsave("namon_p2.png",
       plot = namon_p2,
       path = "./graficos",
       dpi = 300,
       type = "cairo")

ggsave("namon_p3.png",
       plot = namon_p3,
       path = "./graficos",
       dpi = 300,
       type = "cairo")
```

### Turbidez

```{r Gráfico Turbidez facetted, fig.cap="turbidez-gravataí no período 1990-2020", warning = FALSE, message = FALSE}
(turb <- plan_wide_19902020 %>% 
   boxplot_turb(
     titulo = "Turbidez no período 1990-2020"
   )+
   facet_wrap(~periodo)
 )
```

```{r Gráfico Turbidez line, warning = FALSE, message = FALSE}
(turb_overview <- ts_turbidez()+
  scale_y_continuous(expand = expansion(mult = c(0.05, 0.05)),
                     breaks = c(5, 10, 50, 100, 500),
                     limits = c(
                       # 1,
                       min(plan_wide_19902020$turbidez, na.rm = TRUE),
                       # 500
                       max(plan_wide_19902020$turbidez, na.rm = TRUE)
                     ),
                     trans = "log10",
                     labels = scales::number_format(accuracy = 1,
                                                    decimal.mark = ",",
                                                    big.mark = " "))
 )
```

```{r Gráfico Turbidez periodo1, warning = FALSE, message = FALSE}
(turb_p1 <- plan_wide_19902020 %>% 
   filter(ano_coleta>"1990" &
            ano_coleta<="2000") %>% 
   boxplot_turb(
     titulo = "Turbidez no período 1990-2000"
   )
 )
```

```{r Gráfico Turbidez periodo2, warning = FALSE, message = FALSE}
(turb_p2 <- plan_wide_19902020 %>% 
   filter(ano_coleta>"2000" &
            ano_coleta<="2010") %>% 
   boxplot_turb(
     titulo = "Turbidez no período 2000-2010"
   )
 )
```

```{r Gráfico Turbidez periodo3, warning = FALSE, message = FALSE}
(turb_p3 <- plan_wide_19902020 %>% 
   filter(ano_coleta>"2010" &
            ano_coleta<="2020") %>% 
   boxplot_turb(
     titulo = "Turbidez no período 2010-2020"
   )
 )
```

```{r Sumário Turbidez, warning=FALSE, message = FALSE,}
(sum_turb_p1 <- plan_wide_19902020 %>%
   dplyr::select(codigo, turbidez, ano_coleta) %>% 
   filter(ano_coleta>"1990" &
            ano_coleta<="2000") %>% 
   group_by(codigo) %>% 
   summarize(
     min = 
       min(turbidez, 
           na.rm = TRUE),
     q1 = 
       quantile(turbidez, 0.25, 
                na.rm = TRUE),
     median = 
       median(turbidez, 
              na.rm = TRUE),
     mean = 
       mean(turbidez, 
            na.rm= TRUE),
     q3 = 
       quantile(turbidez, 0.75, 
                na.rm = TRUE),
     max = 
       max(turbidez, 
           na.rm = TRUE))
)

(sum_turb_p2 <- plan_wide_19902020 %>%
    dplyr::select(codigo, turbidez, ano_coleta) %>% 
    filter(ano_coleta>"2000" &
             ano_coleta<="2010") %>% 
    group_by(codigo) %>% 
    summarize(
      min = 
        min(turbidez, 
            na.rm = TRUE),
      q1 = 
        quantile(turbidez, 0.25, 
                 na.rm = TRUE),
      median = 
        median(turbidez, 
               na.rm = TRUE),
      mean = 
        mean(turbidez, 
             na.rm= TRUE),
      q3 = 
        quantile(turbidez, 0.75, 
                 na.rm = TRUE),
      max = 
        max(turbidez, 
            na.rm = TRUE))
)

(sum_turb_p3 <- plan_wide_19902020 %>%
    dplyr::select(codigo, turbidez, ano_coleta) %>% 
    filter(ano_coleta>"2010" &
             ano_coleta<="2020") %>% 
    group_by(codigo) %>% 
    summarize(
      min = 
        min(turbidez, 
            na.rm = TRUE),
      q1 = 
        quantile(turbidez, 0.25, 
                 na.rm = TRUE),
      median = 
        median(turbidez, 
               na.rm = TRUE),
      mean = 
        mean(turbidez, 
             na.rm= TRUE),
      q3 = 
        quantile(turbidez, 0.75, 
                 na.rm = TRUE),
      max = 
        max(turbidez, 
            na.rm = TRUE))
) 
```

```{r Salvando turb, warning=FALSE, message = FALSE,}
ggsave("turb.png",
       units = c("px"),
       width = 4500,
       height = 2993,
       plot = turb,
       path = "./graficos",
       dpi = 300,
       type = "cairo")

ggsave("turb_overview.png",
       units = c("px"),
       width = 4500,
       height = 2993,
       plot = turb_overview,
       path = "./graficos",
       dpi = 300,
       type = "cairo")

ggsave("turb_p1.png",
       plot = turb_p1,
       path = "./graficos",
       dpi = 300,
       type = "cairo")

ggsave("turb_p2.png",
       plot = turb_p2,
       path = "./graficos",
       dpi = 300,
       type = "cairo")

ggsave("turb_p3.png",
       plot = turb_p3,
       path = "./graficos",
       dpi = 300,
       type = "cairo")
```

### pH

```{r Gráfico pH facetted, fig.cap="pH-gravataí no período 1990-2020", warning = FALSE, message = FALSE}
(pH <- boxplot_pH(
  titulo = "pH no período 1990-2020"
)+
  facet_wrap(~periodo)
)
```

```{r Gráfico pH periodo1, warning = FALSE, message = FALSE}
(pH_p1 <- plan_wide_19902020 %>% 
   filter(ano_coleta > "1990" &
            ano_coleta <= "2000") %>% 
   boxplot_pH(
     titulo = "pH no período 1990-2000"
   )
 )
```

```{r Gráfico pH periodo2, warning = FALSE, message = FALSE}
(pH_p2 <- plan_wide_19902020 %>% 
   filter(ano_coleta > "2000" &
            ano_coleta <= "2010") %>% 
   boxplot_pH(
     titulo = "pH no período 2000-2010"
   )
 )
```

```{r Gráfico pH periodo3, warning = FALSE, message = FALSE}
(pH_p3 <- plan_wide_19902020 %>% 
   filter(ano_coleta > "2010" &
            ano_coleta <= "2020") %>% 
   boxplot_pH(
     titulo = "pH no período 2010-2020"
   )
 )
```

```{r Gráfico pH line, warning = FALSE, message = FALSE}
pH_overview <- ts_pH()+
  scale_y_continuous(expand = expansion(mult = c(0.05, 0.05)),
                     breaks = c(4.5, 6, 7.5, 9, 10.5),
                     limits = c(4.5, 10.5),
                     labels = scales::number_format(accuracy = .1,
                                                    decimal.mark = ",",
                                                    big.mark = " "))
```

```{r Sumário pH, warning=FALSE, message = FALSE,}
(sum_pH_p1 <- plan_wide_19902020 %>%
   dplyr::select(codigo, pH, ano_coleta) %>% 
   filter(ano_coleta>"1990" &
            ano_coleta<="2000") %>% 
   group_by(codigo) %>% 
   summarize(
     min = 
       min(pH, 
           na.rm = TRUE),
     q1 = 
       quantile(pH, 0.25, 
                na.rm = TRUE),
     median = 
       median(pH, 
              na.rm = TRUE),
     mean = 
       mean(pH, 
            na.rm= TRUE),
     q3 = 
       quantile(pH, 0.75, 
                na.rm = TRUE),
     max = 
       max(pH, 
           na.rm = TRUE))
)

(sum_pH_p2 <- plan_wide_19902020 %>%
    dplyr::select(codigo, pH, ano_coleta) %>% 
    filter(ano_coleta>"2000" &
             ano_coleta<="2010") %>% 
    group_by(codigo) %>% 
    summarize(
      min = 
        min(pH, 
            na.rm = TRUE),
      q1 = 
        quantile(pH, 0.25, 
                 na.rm = TRUE),
      median = 
        median(pH, 
               na.rm = TRUE),
      mean = 
        mean(pH, 
             na.rm= TRUE),
      q3 = 
        quantile(pH, 0.75, 
                 na.rm = TRUE),
      max = 
        max(pH, 
            na.rm = TRUE))
) 

(sum_pH_p3 <- plan_wide_19902020 %>%
    dplyr::select(codigo, pH, ano_coleta) %>% 
    filter(ano_coleta>"2010" &
             ano_coleta<="2020") %>% 
    group_by(codigo) %>% 
    summarize(
      min = 
        min(pH, 
            na.rm = TRUE),
      q1 = 
        quantile(pH, 0.25, 
                 na.rm = TRUE),
      median = 
        median(pH, 
               na.rm = TRUE),
      mean = 
        mean(pH, 
             na.rm= TRUE),
      q3 = 
        quantile(pH, 0.75, 
                 na.rm = TRUE),
      max = 
        max(pH, 
            na.rm = TRUE))
)
```

```{r Salvando pH, warning=FALSE, message = FALSE,}
ggsave("pH.png",
       units = c("px"),
       width = 4500,
       height = 2993,
       plot = pH,
       path = "./graficos",
       dpi = 300,
       type = "cairo")

ggsave("pH_p1.png",
       plot = pH_p1,
       path = "./graficos",
       dpi = 300,
       type = "cairo")

ggsave("pH_p2.png",
       plot = pH_p2,
       path = "./graficos",
       dpi = 300,
       type = "cairo")

ggsave("pH_p3.png",
       plot = pH_p3,
       path = "./graficos",
       dpi = 300,
       type = "cairo")
```

### Sólidos totais

```{r Gráfico SólTot facetted, fig.cap="sólidos-totais-gravataí no período 1990-2020", warning = FALSE, message = FALSE}
(SolTot <- plan_wide_19902020 %>% 
   boxplot_solidos_totais(
     titulo = "Sólidos totais no período 1990-2020"
   )+
   facet_wrap(~periodo)
)
```

```{r Gráfico SólTot periodo1, warning = FALSE, message = FALSE}
(SolTot_p1 <- plan_wide_19902020 %>% 
   filter(ano_coleta>"1990" &
          ano_coleta<="2000") %>% 
   boxplot_solidos_totais(
     titulo = "Sólidos totais no período 1990-2000"
   )
 )
```

```{r Gráfico SólTot periodo2, warning = FALSE, message = FALSE}
(SolTot_p2 <- plan_wide_19902020 %>% 
   filter(ano_coleta>"2000" &
            ano_coleta<="2010") %>% 
   boxplot_solidos_totais(
     titulo = "Sólidos totais no período 2000-2010"
   )
)
```

```{r Gráfico SólTot periodo3, warning = FALSE, message = FALSE}
(SolTot_p3 <- plan_wide_19902020 %>% 
   filter(ano_coleta>"2010" &
            ano_coleta<="2020") %>% 
   boxplot_solidos_totais(
     titulo = "Sólidos totais no período 2010-2020"
   )
)
```

```{r Gráfico SólTot line, warning = FALSE, message = FALSE}
(solidos_totais_overview <- ts_solidos_totais()+
  scale_y_continuous(expand = expansion(mult = c(0.05, 0.05)),
                     breaks = c(10, 50, 100, 500),
                     limits = c(min(plan_wide_19902020$solidos_totais, na.rm = TRUE),
                                max(plan_wide_19902020$solidos_totais, na.rm = TRUE)),
                     labels = scales::number_format(accuracy = 1,
                                                    decimal.mark = ",",
                                                    big.mark = " "),
                     trans = "log10")
 )
```

```{r Sumário Sólidos Totais, warning=FALSE, message = FALSE,}
(sum_SolTot_p1 <- plan_wide_19902020 %>%
   dplyr::select(codigo, solidos_totais, ano_coleta) %>% 
   filter(ano_coleta>"1990" &
            ano_coleta<="2000") %>% 
   group_by(codigo) %>% 
   summarize(
     min = 
       min(solidos_totais, 
           na.rm = TRUE),
     q1 = 
       quantile(solidos_totais, 0.25, 
                na.rm = TRUE),
     median = 
       median(solidos_totais, 
              na.rm = TRUE),
     mean = 
       mean(solidos_totais, 
            na.rm= TRUE),
     q3 = 
       quantile(solidos_totais, 0.75, 
                na.rm = TRUE),
     max = 
       max(solidos_totais, 
           na.rm = TRUE))
)

(sum_SolTot_p2 <- plan_wide_19902020 %>%
    dplyr::select(codigo, solidos_totais, ano_coleta) %>% 
    filter(ano_coleta>"2000" &
             ano_coleta<="2010") %>% 
    group_by(codigo) %>% 
    summarize(
      min = 
        min(solidos_totais, 
            na.rm = TRUE),
      q1 = 
        quantile(solidos_totais, 0.25, 
                 na.rm = TRUE),
      median = 
        median(solidos_totais, 
               na.rm = TRUE),
      mean = 
        mean(solidos_totais, 
             na.rm= TRUE),
      q3 = 
        quantile(solidos_totais, 0.75, 
                 na.rm = TRUE),
      max = 
        max(solidos_totais, 
            na.rm = TRUE))
)

(sum_SolTot_p3 <- plan_wide_19902020 %>%
    dplyr::select(codigo, solidos_totais, ano_coleta) %>% 
    filter(ano_coleta>"2010" &
             ano_coleta<="2020") %>% 
    group_by(codigo) %>% 
    summarize(
      min = 
        min(solidos_totais, 
            na.rm = TRUE),
      q1 = 
        quantile(solidos_totais, 0.25, 
                 na.rm = TRUE),
      median = 
        median(solidos_totais, 
               na.rm = TRUE),
      mean = 
        mean(solidos_totais, 
             na.rm= TRUE),
      q3 = 
        quantile(solidos_totais, 0.75, 
                 na.rm = TRUE),
      max = 
        max(solidos_totais, 
            na.rm = TRUE))
)
```

```{r Salvando SolTot, warning=FALSE, message = FALSE,}
ggsave("SolTot.png",
       units = c("px"),
       width = 4500,
       height = 2993,
       plot = SolTot,
       path = "./graficos",
       dpi = 300,
       type = "cairo")

ggsave("solidos_totais_overview.png",
       units = c("px"),
       width = 4500,
       height = 2993,
       plot = solidos_totais_overview,
       path = "./graficos",
       dpi = 300,
       type = "cairo")

ggsave("SolTot_p1.png",
       plot = SolTot_p1,
       path = "./graficos",
       dpi = 300,
       type = "cairo")

ggsave("SolTot_p2.png",
       plot = SolTot_p2,
       path = "./graficos",
       dpi = 300,
       type = "cairo")

ggsave("SolTot_p3.png",
       plot = SolTot_p3,
       path = "./graficos",
       dpi = 300,
       type = "cairo")
```

### Condutividade elétrica

```{r Gráfico cond_elet facetted, fig.cap="condutividade-eletrica-gravataí no período 1990-2020", warning = FALSE, message = FALSE}
(cond_elet <- plan_wide_19902020 %>% 
   boxplot_cond_elet(
     titulo = "Condutividade elétrica no período 1990-2020"
   )+
   facet_wrap(~periodo)
)
```

```{r Gráfico cond_elet periodo1, warning = FALSE, message = FALSE}
(cond_elet_p1 <- plan_wide_19902020 %>% 
   filter(ano_coleta>"1990" &
            ano_coleta<="2000") %>% 
   boxplot_cond_elet(
     titulo = "Condutividade elétrica no período 1990-2000"
   )
)
```

```{r Gráfico cond_elet periodo2, warning = FALSE, message = FALSE}
(cond_elet_p2 <- plan_wide_19902020 %>% 
   filter(ano_coleta>"2000" &
            ano_coleta<="2010") %>% 
   boxplot_cond_elet(
     titulo = "Condutividade elétrica no período 2000-2010"
   )
)
```

```{r Gráfico cond_elet periodo3, warning = FALSE, message = FALSE}
(cond_elet_p3 <- plan_wide_19902020 %>% 
   filter(ano_coleta>"2010" &
            ano_coleta<="2020") %>% 
   boxplot_cond_elet(
     titulo = "Condutividade elétrica no período 2010-2020"
   )
)
```

```{r Gráfico cond_elet line, warning = FALSE, message = FALSE}
(condutividade_overview <- ts_condutividade()+
  scale_y_continuous(expand = expansion(mult = c(0.01, 0.05)),
                     # n.breaks = 8,
                     limits = c(
                       # min(plan_wide_19902020$condutividade, na.rm = TRUE),
                       5,
                       1000
                       # max(plan_wide_19902020$condutividade, na.rm = TRUE)
                     ),
                     breaks = c(10, 50, 100, 500, 1000),
                     labels = scales::number_format(accuracy = 1,
                                                    decimal.mark = ",",
                                                    big.mark = " "),
                     trans = "log10")
 )
```

```{r Sumário cond_elet, warning=FALSE, message = FALSE}
(sum_cond_elet_p1 <- plan_wide_19902020 %>%
   dplyr::select(codigo, condutividade, ano_coleta) %>% 
   filter(ano_coleta>"1990" &
            ano_coleta<="2000") %>% 
   group_by(codigo) %>% 
   summarize(
     min = 
       min(condutividade, 
           na.rm = TRUE),
     q1 = 
       quantile(condutividade, 0.25, 
                na.rm = TRUE),
     median = 
       median(condutividade, 
              na.rm = TRUE),
     mean = 
       mean(condutividade, 
            na.rm= TRUE),
     q3 = 
       quantile(condutividade, 0.75, 
                na.rm = TRUE),
     max = 
       max(condutividade, 
           na.rm = TRUE))
)

(sum_cond_elet_p2 <- plan_wide_19902020 %>%
    dplyr::select(codigo, condutividade, ano_coleta) %>% 
    filter(ano_coleta>"2000" &
             ano_coleta<="2010") %>% 
    group_by(codigo) %>% 
    summarize(
      min = 
        min(condutividade, 
            na.rm = TRUE),
      q1 = 
        quantile(condutividade, 0.25, 
                 na.rm = TRUE),
      median = 
        median(condutividade, 
               na.rm = TRUE),
      mean = 
        mean(condutividade, 
             na.rm= TRUE),
      q3 = 
        quantile(condutividade, 0.75, 
                 na.rm = TRUE),
      max = 
        max(condutividade, 
            na.rm = TRUE))
)

(sum_cond_elet_p3 <- plan_wide_19902020 %>%
    dplyr::select(codigo, condutividade, ano_coleta) %>% 
    filter(ano_coleta>"2010" &
             ano_coleta<="2020") %>% 
    group_by(codigo) %>% 
    summarize(
      min = 
        min(condutividade, 
            na.rm = TRUE),
      q1 = 
        quantile(condutividade, 0.25, 
                 na.rm = TRUE),
      median = 
        median(condutividade, 
               na.rm = TRUE),
      mean = 
        mean(condutividade, 
             na.rm= TRUE),
      q3 = 
        quantile(condutividade, 0.75, 
                 na.rm = TRUE),
      max = 
        max(condutividade, 
            na.rm = TRUE),
      n = 
        length(condutividade))
)

# plan_wide_19902020 %>% 
#    select(codigo, IQA) %>% 
#    group_by(codigo) %>% 
#    summarize(
#       min = 
#          min(IQA, 
#              na.rm = TRUE),
#       q1 = 
#          quantile(IQA, 0.25, 
#                   na.rm = TRUE),
#       median = 
#          median(IQA, 
#                 na.rm = TRUE),
#       mean = 
#          mean(IQA, 
#               na.rm= TRUE),
#       q3 = 
#          quantile(IQA, 0.75, 
#                   na.rm = TRUE),
#       max = 
#          max(IQA, 
#              na.rm = TRUE))
```

```{r Salvando cond_elet, warning=FALSE, message = FALSE}
ggsave("cond_elet.png",
       units = c("px"),
       width = 4500,
       height = 2993,
       plot = cond_elet,
       path = "./graficos",
       dpi = 300,
       type = "cairo")

ggsave("condutividade_overview.png",
       units = c("px"),
       width = 4500,
       height = 2993,
       plot = condutividade_overview,
       path = "./graficos",
       dpi = 300,
       type = "cairo")

ggsave("cond_elet_p1.png",
       plot = cond_elet_p1,
       path = "./graficos",
       dpi = 300,
       type = "cairo")

ggsave("cond_elet_p2.png",
       plot = cond_elet_p2,
       path = "./graficos",
       dpi = 300,
       type = "cairo")

ggsave("cond_elet_p3.png",
       plot = cond_elet_p3,
       path = "./graficos",
       dpi = 300,
       type = "cairo")
```

### IQA

```{r Gráfico IQA facetted, fig.cap="iqa-gravataí no período 1990-2020", echo = FALSE, message=FALSE, warning=FALSE}
(iqa <-ggplot(plan_wide_19902020,
              aes(codigo,
                  iqa, na.rm = TRUE))+
   annotate("rect",
            xmin=-Inf,
            xmax=Inf,
            ymin=-Inf,
            ymax=25,
            alpha=1,
            fill="#ac5079")+ #>pior classe
   annotate("rect",
            xmin=-Inf,
            xmax=Inf,
            ymin=25,
            ymax=50,
            alpha=1,
            fill="#eb5661")+ #classe 4
   annotate("rect",
            xmin=-Inf,
            xmax=Inf,
            ymin=50,
            ymax=70,
            alpha=1,
            fill="#fcf7ab")+ #classe 3
   annotate("rect",
            xmin=-Inf,
            xmax=Inf,
            ymin=70,
            ymax=90,
            alpha=1,
            fill="#70c18c")+ #classe 2
   annotate("rect",
            xmin=-Inf,
            xmax=Inf,
            ymin=90,
            ymax=Inf,
            alpha=1,
            fill="#8dcdeb")+ #classe 1
   stat_summary(
     fun.data = f,
     geom = 'errorbar',
     width = 0.3,
     position = position_dodge(width = 0.65),
   )+
   stat_summary(
     fun.data = f,
     geom = "boxplot",
     width = 0.7,
     fill = '#F8F8FF',
     color = "black",
     outlier.shape = NA, #se deixar NA fica só o jitter, se não, deixa 1
   )+
   facet_wrap(~periodo)+
   labs(title = "Variação do IQA no período 1990-2020",
        x="Estação",
        y="IQA")+
   scale_y_continuous(expand = expansion(mult = c(0,0)),
                      n.breaks = 6,
                      limits = c(-1,101))+
   ggbeeswarm::geom_quasirandom(
     size = 1.2,
     alpha = .25,
     width = .07,
   )+
   scale_x_discrete(limits = c("87398500", 
                               "87398980", 
                               "87398900", 
                               "87398950", 
                               "87405500", 
                               "87406900", 
                               "87409900"),
                    labels = c("PM1", "PM2", "PM3", "PM4", "PM5", "PM6", "PM7")
   )+
   geom_smooth(method = "lm",
               se=FALSE, #se deixar TRUE gera o intervalo de confiança de 95%
               aes(group=1),
               alpha=.5,
               na.rm = TRUE,
               linewidth = 1)+
   theme_grafs()
   # theme(axis.title.y = element_blank())
)
```

```{r Gráfico IQA periodo1, echo = FALSE, message=FALSE, warning=FALSE}
(iqa_p1 <-ggplot(plan_wide_19902020 %>% 
                   filter(ano_coleta > "1990" &
                            ano_coleta <= "2000"),
                 aes(codigo,
                     iqa, na.rm = TRUE))+
    annotate("rect",
            xmin=-Inf,
            xmax=Inf,
            ymin=-Inf,
            ymax=25,
            alpha=1,
            fill="#ac5079")+ #>pior classe
   annotate("rect",
            xmin=-Inf,
            xmax=Inf,
            ymin=25,
            ymax=50,
            alpha=1,
            fill="#eb5661")+ #classe 4
   annotate("rect",
            xmin=-Inf,
            xmax=Inf,
            ymin=50,
            ymax=70,
            alpha=1,
            fill="#fcf7ab")+ #classe 3
   annotate("rect",
            xmin=-Inf,
            xmax=Inf,
            ymin=70,
            ymax=90,
            alpha=1,
            fill="#70c18c")+ #classe 2
   annotate("rect",
            xmin=-Inf,
            xmax=Inf,
            ymin=90,
            ymax=Inf,
            alpha=1,
            fill="#8dcdeb")+ #classe 1
    stat_boxplot(geom = 'errorbar',
                 width=0.3,
                 position = position_dodge(width = 0.65),
                 na.rm = TRUE)+
    geom_boxplot(fill='#F8F8FF',
                 color="black",
                 outlier.shape = NA, #se deixar NA fica só o jitter, se não, deixa 1
                 width= 0.7,
                 na.rm = TRUE)+
    labs(title = "Variação do IQA no período 1990-2000",
         x="Estação",
         y="")+
    scale_y_continuous(expand = expansion(mult = c(0,0)),
                       n.breaks = 6,
                       limits = c(-1,101))+
    ggbeeswarm::geom_quasirandom(
     size = 1.2,
     alpha = .25,
     width = .07,
   )+
   scale_x_discrete(limits = c("87398500", 
                               "87398980", 
                               "87398900", 
                               "87398950", 
                               "87405500", 
                               "87406900", 
                               "87409900"),
                    labels = c("PM1", "PM2", "PM3", "PM4", "PM5", "PM6", "PM7")
   )+
    geom_smooth(method = "lm",
                se=FALSE, #se deixar TRUE gera o intervalo de confiança de 95%
                aes(group=1),
                alpha=.5,
                na.rm = TRUE,
                linewidth = 1)+
   theme_grafs()+
   theme(axis.title.y = element_blank())
)
```

```{r Gráfico IQA periodo2, echo = FALSE, message=FALSE, warning=FALSE}
(iqa_p2 <-ggplot(plan_wide_19902020 %>% 
                   filter(ano_coleta > "2000" &
                            ano_coleta <= "2010"),
                 aes(codigo,
                     iqa, na.rm = TRUE))+
   annotate("rect",
            xmin=-Inf,
            xmax=Inf,
            ymin=-Inf,
            ymax=25,
            alpha=1,
            fill="#ac5079")+ #>pior classe
   annotate("rect",
            xmin=-Inf,
            xmax=Inf,
            ymin=25,
            ymax=50,
            alpha=1,
            fill="#eb5661")+ #classe 4
   annotate("rect",
            xmin=-Inf,
            xmax=Inf,
            ymin=50,
            ymax=70,
            alpha=1,
            fill="#fcf7ab")+ #classe 3
   annotate("rect",
            xmin=-Inf,
            xmax=Inf,
            ymin=70,
            ymax=90,
            alpha=1,
            fill="#70c18c")+ #classe 2
   annotate("rect",
            xmin=-Inf,
            xmax=Inf,
            ymin=90,
            ymax=Inf,
            alpha=1,
            fill="#8dcdeb")+ #classe 1
   stat_boxplot(geom = 'errorbar',
                width=0.3,
                position = position_dodge(width = 0.65),
                na.rm = TRUE)+
   geom_boxplot(fill='#F8F8FF',
                color="black",
                outlier.shape = NA, #se deixar NA fica só o jitter, se não, deixa 1
                width= 0.7,
                na.rm = TRUE)+
   labs(title = "Variação do IQA no período 2000-2010",
        x="Estação",
        y="")+
   scale_y_continuous(expand = expansion(mult = c(0,0)),
                      n.breaks = 6,
                      limits = c(-1,101))+
   ggbeeswarm::geom_quasirandom(
     size = 1.2,
     alpha = .25,
     width = .07,
   )+
   scale_x_discrete(limits = c("87398500", 
                               "87398980", 
                               "87398900", 
                               "87398950", 
                               "87405500", 
                               "87406900", 
                               "87409900"),
                    labels = c("PM1", "PM2", "PM3", "PM4", "PM5", "PM6", "PM7")
   )+
   geom_smooth(method = "lm",
               se=FALSE, #se deixar TRUE gera o intervalo de confiança de 95%
               aes(group=1),
               alpha=.5,
               na.rm = TRUE,
               linewidth = 1)+
 theme_grafs()+
   theme(axis.title.y = element_blank()
   )
)
```

```{r Gráfico IQA periodo3, echo = FALSE, message=FALSE, warning=FALSE}
(iqa_p3 <-ggplot(plan_wide_19902020 %>% 
                   filter(ano_coleta > "2010" &
                            ano_coleta <= "2020"),
                 aes(codigo,
                     iqa, na.rm = TRUE))+
   annotate("rect",
            xmin=-Inf,
            xmax=Inf,
            ymin=-Inf,
            ymax=25,
            alpha=1,
            fill="#ac5079")+ #>pior classe
   annotate("rect",
            xmin=-Inf,
            xmax=Inf,
            ymin=25,
            ymax=50,
            alpha=1,
            fill="#eb5661")+ #classe 4
   annotate("rect",
            xmin=-Inf,
            xmax=Inf,
            ymin=50,
            ymax=70,
            alpha=1,
            fill="#fcf7ab")+ #classe 3
   annotate("rect",
            xmin=-Inf,
            xmax=Inf,
            ymin=70,
            ymax=90,
            alpha=1,
            fill="#70c18c")+ #classe 2
   annotate("rect",
            xmin=-Inf,
            xmax=Inf,
            ymin=90,
            ymax=Inf,
            alpha=1,
            fill="#8dcdeb")+ #classe 1
   stat_boxplot(geom = 'errorbar',
                width=0.3,
                position = position_dodge(width = 0.65),
                na.rm = TRUE)+
   geom_boxplot(fill='#F8F8FF',
                color="black",
                outlier.shape = NA, #se deixar NA fica só o jitter, se não, deixa 1
                width= 0.7,
                na.rm = TRUE)+
   labs(title = "Variação do IQA no período 2010-2020",
        x="Estação",
        y="")+
   scale_y_continuous(expand = expansion(mult = c(0,0)),
                      n.breaks = 6,
                      limits = c(-1,101))+
   ggbeeswarm::geom_quasirandom(
     size = 1.2,
     alpha = .25,
     width = .07,
   )+
   scale_x_discrete(limits = c("87398500", 
                               "87398980", 
                               "87398900", 
                               "87398950", 
                               "87405500", 
                               "87406900", 
                               "87409900"),
                    labels = c("PM1", "PM2", "PM3", "PM4", "PM5", "PM6", "PM7")
   )+
   geom_smooth(method = "lm",
               se=FALSE, #se deixar TRUE gera o intervalo de confiança de 95%
               aes(group=1),
               alpha=.5,
               na.rm = TRUE,
               linewidth = 1)+
    theme_grafs()+
    theme(axis.title.y = element_blank())
)
```

```{r Sumário IQA, warning=FALSE, message = FALSE,}
(sum_IQA_p1 <- plan_wide_19902020 %>%
   dplyr::select(codigo, iqa, ano_coleta) %>% 
   filter(ano_coleta>"1990" &
            ano_coleta<="2000") %>% 
   group_by(codigo) %>% 
   summarize(
     min = 
       min(iqa, 
           na.rm = TRUE),
     q1 = 
       quantile(iqa, 0.25, 
                na.rm = TRUE),
     median = 
       median(iqa, 
              na.rm = TRUE),
     mean = 
       mean(iqa, 
            na.rm= TRUE),
     q3 = 
       quantile(iqa, 0.75, 
                na.rm = TRUE),
     max = 
       max(iqa, 
           na.rm = TRUE),
     n = 
        length(iqa)
   )
)

(sum_IQA_p2 <- plan_wide_19902020 %>%
    dplyr::select(codigo, iqa, ano_coleta) %>% 
    filter(ano_coleta>"2000" &
             ano_coleta<="2010") %>% 
    group_by(codigo) %>% 
    summarize(
      min = 
        min(iqa, 
            na.rm = TRUE),
      q1 = 
        quantile(iqa, 0.25, 
                 na.rm = TRUE),
      median = 
        median(iqa, 
               na.rm = TRUE),
      mean = 
        mean(iqa, 
             na.rm= TRUE),
      q3 = 
        quantile(iqa, 0.75, 
                 na.rm = TRUE),
      max = 
        max(iqa, 
            na.rm = TRUE),
      n = 
        length(iqa)
      )
)

(sum_IQA_p3 <- plan_wide_19902020 %>%
    dplyr::select(codigo, iqa, ano_coleta) %>% 
    filter(ano_coleta>"2010" &
             ano_coleta<="2020") %>%
    # ?as_factor(codigo) %>% 
    group_by(codigo) %>%
    summarize(
      min = 
        min(iqa, 
            na.rm = TRUE),
      q1 = 
        quantile(iqa, 0.25, 
                 na.rm = TRUE),
      median = 
        median(iqa, 
               na.rm = TRUE),
      mean = 
        mean(iqa, 
             na.rm= TRUE),
      q3 = 
        quantile(iqa, 0.75, 
                 na.rm = TRUE),
      max = 
        max(iqa, 
            na.rm = TRUE),
      n = 
        length(iqa),
      NAs = 
        sum(is.na(iqa))
      ) %>% 
  mutate(
    "%NA" = NAs/n*100
  )
)

```

```{r Salvando iqa, warning=FALSE, message = FALSE,}
ggsave("iqa.png",
       units = c("px"),
       width = 4500,
       height = 2993,
       plot = iqa,
       path = "./graficos",
       dpi = 300,
       type = "cairo")

ggsave("iqa_p1.png",
       plot = iqa_p1,
       path = "./graficos",
       dpi = 300,
       type = "cairo")

ggsave("iqa_p2.png",
       plot = iqa_p2,
       path = "./graficos",
       dpi = 300,
       type = "cairo")

ggsave("iqa_p3.png",
       plot = iqa_p3,
       path = "./graficos",
       dpi = 300,
       type = "cairo")
```

## Correlação

```{r Correlação, fig.cap="correlação-parametros-qualidade-agua-gravataí no período 1990-2020", time_it = TRUE, warning=FALSE, message = FALSE,}
parametros_IQA %>% 
  dplyr::select(
    -codigo,
    -ano_coleta,
    -nitrogenio_total
    ) %>% 
  # group_by(codigo) %>% 
  rename(
    CE = condutividade,
    E_coli = escherichia_coli,
    OD = oxigenio_dissolvido,
    ST = solidos_totais,
    Turb = turbidez,
    Temp = temperatura_agua,
    Ptot = fosforo_total,
    # NTot = nitrogenio_total,
    NAmon = nitrogenio_amoniacal,
    NTK = nitrogenio_kjeldahl
  ) %>% 
  ggcorr(
    method = "complete.obs",
    # "pearson",
    # "pairwise",
    name = "Correlação",
    label = TRUE,
    label_alpha = TRUE,
    digits = 3,
    low = "#3B9AB2",
    mid = "#EEEEEE",
    high = "#F21A00",
    # palette = "RdYlBu",
    layout.exp = 0,
    legend.position = "left",
    label_round = 3,
    # legend.size = 18,
    geom = "tile",
    nbreaks = 10,
  )+
  labs(title = "Correlação entre parâmetros físico-químicos na\nBacia Hidrográfica do rio Gravataí no período 1990-2020")+
  theme_linedraw()+
  theme(
    legend.position = c(0.15, 0.6),
    legend.title = element_text(size = 16),
    legend.text = element_text(size = 14),
    # legend.spacing = unit(element_text(),
                          # units = 5)
    plot.title = element_text(hjust = 0.5,
                              size = 16)
  )

# Gráfico das correlações entre todos os parâmetros com significância
correl_IQA <- parametros_IQA %>%
  dplyr::select(-codigo) %>%
  ggpairs(title = "Correlação entre parâmetros que compõem o IQA",
          axisLabels = "show")

correlacao_pIQA <- parametros_IQA %>% 
  group_by(codigo) %>% 
  correlation::correlation()

correlacao_pIQA %>% 
  # glimpse()
  filter(
    p < 0.001
  ) %>% 
  as_tibble() %>% 
  # filter(
  #   Parameter1 == "oxigenio_dissolvido"
  # ) %>% 
  arrange(desc(r)) 
  
parametros_IQA %>% 
  # group_by(codigo) %>% 
  dplyr::select(
    nitrogenio_kjeldahl, condutividade
  ) %>% 
  # correlation::cor_test() %>% 
  plot()
```

# Mapas

## Pacotes necessários

```{r}
pacman::p_load(
  ggspatial,
  geobr,
  terra,
  tmaptools,
  ggrepel,
  geomtextpath
)
```

## mapa ETEs 2013 x 2019

### import

```{r}
RHG <- st_read(
  "C:/Users/Léo/Desktop/TCC/TCC_github/TCC_gh/info_geoespaciais/regiao_hidrografica_31982.gpkg"
) %>% 
  janitor::clean_names()


municipios_RS <- read_municipality() %>% 
  filter(abbrev_state == "RS") %>% 
  as("sf") %>% 
  filter(
    name_muni == "Alvorada" |
      name_muni == "Araricá" |
      name_muni == "Balneário Pinhal" |
      name_muni == "Barra do Ribeiro" |
      name_muni == "Cachoeirinha" |
      name_muni == "Canoas" |
      name_muni == "Caraá" |
      name_muni == "Campo Bom" |
      name_muni == "Capela De Santana" |
      name_muni == "Capão da Canoa" |
      name_muni == "Capivari Do Sul" |
      name_muni == "Charqueadas" |
      name_muni == "Cidreira" |
      name_muni == "Eldorado Do Sul" |
      name_muni == "Esteio" |
      name_muni == "Gravataí" |
      name_muni == "Glorinha" |
      name_muni == "Guaíba" |
      name_muni == "Imbé" |
      name_muni == "Lagoa Dos Patos" |
      name_muni == "Montenegro" |
      name_muni == "Maquiné" |
      name_muni == "Nova Santa Rita" |
      name_muni == "Novo Hamburgo" |
      name_muni == "Osório" |
      name_muni == "Palmares Do Sul" |
      name_muni == "Parobé" |
      name_muni == "Portão" |
      name_muni == "Porto Alegre" |
      name_muni == "Rolante" |
      name_muni == "Santo Antônio Da Patrulha" |
      name_muni == "São Leopoldo" |
      name_muni == "Sapiranga" |
      name_muni == "Sapucaia Do Sul" |
      name_muni == "Taquara" |
      name_muni == "Tramandaí" |
      name_muni == "Triunfo" |
      name_muni == "Xangri-Lá" |
      name_muni == "Viamão"
  ) %>%
  st_transform(crs = 31982) #4326 = WGS84, 4674 = SIRGAS2000, 31982 = SIRGAS2000/UTM 22S

BH_gravatai <- shapefile(
  "C:/Users/Léo/Desktop/TCC/TCC_github/TCC_gh/info_geoespaciais/Bacia_Hidrografica.shp"
) %>% 
  as("sf") %>% 
  st_transform(crs = 31982) %>% #4326 = WGS84, 4674 = SIRGAS2000, 31982 = SIRGAS2000/UTM 22S
  filter(
    nome == "Gravataí" 
    # | nome == "Lago Guaíba"
  )

ETEs_2013 <- st_read(
  "C:/Users/Léo/Desktop/TCC/TCC_github/TCC_gh/info_geoespaciais/ETEs_2013_31982.gpkg"
) %>% 
  janitor::clean_names() %>% 
  mutate(
    nome_ete = toupper(ete_nm)
  ) 

ETEs_2019 <- st_read(
  "C:/Users/Léo/Desktop/TCC/TCC_github/TCC_gh/info_geoespaciais/ETEs_2019_31982.gpkg"
) %>% 
  janitor::clean_names() %>% 
  mutate(
    nome_ete = toupper(ete_nm)
  )

rio_grav_pol <- shapefile(
  "C:/Users/Léo/Desktop/TCC/dados_digeo_plano_bacia_grav/SIG/Enquadramento/Enquadramento_pol.shp"
) %>% 
  as("sf") %>% 
  st_transform(crs = 31982)

rio_grav_lin <- shapefile(
  "C:/Users/Léo/Desktop/TCC/dados_digeo_plano_bacia_grav/SIG/Enquadramento/Enquadramento_lin.shp"
) %>% 
  as("sf") %>% 
  st_transform(crs = 31982) #4326 = WGS84, 4674 = SIRGAS2000

afluentes <- st_read(
  "C:/Users/Léo/Desktop/TCC/TCC_github/TCC_gh/info_geoespaciais/afluentes_importantes_31982.gpkg"
) %>% 
  janitor::clean_names()

est_monit_BHG <- st_read(
  "C:/Users/Léo/Desktop/TCC/TCC_github/TCC_gh/info_geoespaciais/est_monit_fepam_BHG_31982.gpkg"
) %>% 
  janitor::clean_names() %>% 
  cbind(
    ., 
    st_coordinates(.)
  ) %>% 
  dplyr::select(
    -latitude, -longitude
  ) %>% 
  rename(longitude = X, latitude = Y) %>% 
  mutate_at("codigo", as.character)

est_monit_BHG <- inner_join(
  est_monit_BHG,
  plan_wide_19902020 %>% dplyr::select(codigo, ponto_monitoramento) %>% unique(),
  by = "codigo"
) %>% 
  dplyr::select(codigo, ponto_monitoramento, latitude, longitude, geom)

names(ETEs_2019)

crs(ETEs_2013)
crs(ETEs_2019)

ETEs_2019 %>% glimpse()
ETEs_2013 %>% glimpse()
rio_grav_pol %>% glimpse()
rio_grav_lin %>% glimpse()
```

```{r}
balanco_qualiquant <- st_read(
  "C:/Users/Léo/Desktop/TCC/TCC_github/TCC_gh/info_geoespaciais/balanco_qualiquant_snirh_31982.gpkg"
) 
```

### join

```{r}
ETEs_join <- st_join(
  ETEs_2013,
  ETEs_2019,
) 

# ETEs_BH <- 
#   terra::crop(
#     ETEs_join,
#     BH_gravatai,
#     mask = TRUE
#   )
  
# raster::crop(extent(BH_gravatai$geometry))

ETEs_BH <- ETEs_join %>% 
  tmaptools::crop_shape(ETEs_join,
  BH_gravatai$geometry,
  polygon = TRUE
) %>% 
  # st_as_sf() %>% 
  # st_transform(crs = 31982) %>% 
  dplyr::select(
  1:13,
  geom
  )

n_distinct(ETEs_2019$ete_nm)
n_distinct(ETEs_BH$nome_ete.x)
```

### geração do mapa

```{r}
ggplot()+
  geom_sf(
    data = municipios_RS %>% filter(code_muni == 4300002),
    color = "#5cacee",
    fill = "#5cacee",
  )+
  geom_sf(
    data = municipios_RS,
    fill = "transparent",
  )+
  # annotation_map_tile(
  #   type = "cartolight",
  #   zoom = 10,
  # )+
  # geom_sf_label(
  #   data = municipios_RS %>% 
  #     filter(
  #       !name_muni %in% c("Alvorada", "Cachoeirinha", "Gravataí", "Glorinha", "Santo Antônio Da Patrulha")
  #     ),
  #   aes(label = name_muni),
  #   size = 2.0,
  # )+
  geom_sf(
    data = BH_gravatai,
    alpha = 0.9,
    color = "red",
  )+
  # geom_sf_label(
  #   data = ETEs_BH,
  #   aes(label = ete_faixar)
  #   )+
  # geom_sf(
  #   data = ETEs_BH,
  #   aes(
  #     # group = ete_faixar,
  #     fill = ete_faixar,
  #     color = ete_faixar
  #   )
  # )+
  # geom_sf_label(
  #   data = ETEs_BH,
  #   aes(label = ete_nm.x),
  #   nudge_y = 0.05,
  #   size = 1.5,
  # )+
  labs(
    title = "Remoção de DBO das Estações de Tratamento de Esgoto na BHG",
    caption = "Dados: Carto \uA9\nANA, 2019",
    x = "Longitude",
    y = "Latitude",
  )+
  annotation_scale(
    location = "br", 
    width_hint = 0.2
    )+
  annotation_north_arrow(
    location = "br", 
    which_north = "true", 
    pad_x = unit(0.00, "cm"),
    pad_y = unit(0.55, "cm"),
    style = north_arrow_fancy_orienteering
    )+
  # coord_sf(
  #   xlim = c(-50.4, -51.3),
  #   ylim = c(-29.7, -30.25),
  #   expand = FALSE,
  # )+
   coord_sf(
    xlim = c(479663, 553512),
    ylim = c(6657708, 6709894),
    expand = FALSE,
  )+
  theme_bw()+
  theme(
    plot.title = element_text(
        size = 16,
        hjust = 0.5,
        color = "black",
        face = "bold"
      ),
    legend.position = "right",
    legend.direction = "vertical",
    legend.key.size = unit(0.5, "cm"),
  )

```

```{r mapa localização estações BHG, fig.cap = "Mapa de localização das estações da Bacia Hidrográfica do Rio Gravataí"}
(mapa_localizacao_est_BHG <- municipios_RS %>% 
   ggplot()+
   geom_sf(
    data = municipios_RS %>% filter(code_muni == 4300002),
    color = "#5cacee",
    fill = "#5cacee",
  )+
  geom_sf(
    data = municipios_RS,
    fill = "transparent"
  )+
  geom_sf_text(
    data = municipios_RS,
    aes(label = str_to_upper(name_muni)),
    size = 2,
    # expand = TRUE,
    # clip = "off",
    check_overlap = TRUE,
  )+
  geom_sf(
    data = BH_gravatai,
    color = "red",
    linewidth = 1.02,
    fill = "transparent",
  )+
   geom_sf(
     data = rio_grav_lin,
     color = "#5cacee",
   )+
   geom_sf(
     data = afluentes,
     color = "#5cacee",
   )+
  geom_sf(
    data = rio_grav_pol,
    fill = "#5cacee",
    color = "#5cacee",
  )+
  # geom_sf(
  #   data = ETEs_BH,
  #   aes(
  #     # shape = ete_nm_mun,
  #     # color = ete_nm.x
  #   ),
  #   size = 3,
  # )+
  geom_spatial_point(
    data = est_monit_BHG,
    aes(
      x = longitude,
      y = latitude,
    ),
    shape = 21,
    size = 2.4,
    stroke = 1.2,
    color = "black",
    fill = "white",
    crs = 31982,
    show.legend = TRUE,
  )+
  geom_label_repel(
    data =  est_monit_BHG,
    aes(
      x = longitude,
      y = latitude,
      label = ponto_monitoramento,
    ),
    box.padding = 0.86,
    label.padding = 0.2,
    min.segment.length = 0,
    force = 1,
    direction = "y"
  )+
   labs(
     title = "Localização dos pontos de monitoramento\nde qualidade da água na Bacia Hidrográfica do rio Gravataí",
     # caption = "Elaborado por: Leonardo Fernandes Wink, 2023",
     x = NULL,
     y = NULL,
   )+
   annotation_scale(
    location = "br", 
    width_hint = 0.2
    )+
  annotation_north_arrow(
    location = "br", 
    which_north = "true", 
    pad_x = unit(0.00, "cm"),
    pad_y = unit(0.55, "cm"),
    style = north_arrow_fancy_orienteering
  )+
   # scale_y_continuous(
   #   expand = expansion(mult = c(0,0)),
   #   # n.breaks = 8,
   #   limits = c(6655378, 6712248),
   #   breaks = c(6655378, 6683813, 6712248),
   #   labels = c("6655378", "6683813", "6712248"),
   # )+
   coord_sf(
     # xlim = c(469663, 563512),
     xlim = c(446179.8, 591687.6),
     ylim = c(6655378, 6712248),
     expand = FALSE,
     datum = st_crs(BH_gravatai)
   )+
   theme_bw()+
   theme(
    axis.title.x =
      element_text(
      color = "black",
      size = 10,
      angle = 0,),
      # element_blank(),
    axis.title.y = element_text(
      color = "black",
      size = 10,
      angle = 90),

    axis.text.x = element_text(
      color = "black",
      size = 8),
    axis.text.y = element_text(
      hjust = 0.5,
      color = "black",
      size = 8,
      angle = 90),
    plot.background = element_rect(
      fill = "white",
      color = "black",
      linewidth = 1,
    ),
    panel.background = element_rect(fill = "white"),
    # plot.margin = margin(t = 0.25, r = 0.25, b = 0.25, l = 0.25, "cm"),
    plot.margin = margin(l = 5, r = 10,
                         b = 2, t = 2, unit = "mm"),
    
    plot.title = element_text(
      size = 16,
      hjust = 0.5,
      color = "black",
      face = "bold"
    ),
    legend.position = "right",
    legend.direction = "vertical",
    legend.key.size = unit(0.5, "cm"),
   )
 )

mapa_localizacao_est_BHG
```

```{r criando inset map}
library(grid)
brasil <- read_country()
sul_br <- read_region()
estados_br <- read_state()

(inset_map_br <- ggplot()+
    geom_sf(data = brasil)+
    geom_sf(data = estados_br, fill = grey(0.92))+
    geom_sf(
      data = estados_br %>% filter(abbrev_state == "RS"),
      fill = "yellow",
      alpha = 0.5
    )+
    # geom_spatial_label_repel(
    # geom_sf_text(
    # data = estados_br,
    # aes(label = abbrev_state),
    # alpha = 1.0,
    # crs = 31982,
    # aes(
    #   x = estados_br$geom,
    #   y = estados_br$geom,
    #   label = abbrev_state,
    # ),
  # box.padding = 0.86,
  # )+
  # st_bbox(BH_gravatai)
  geom_rect(
    aes(
      xmin = -50.4, xmax = -51.3,
      ymin = -29.7, ymax = -30.3,
    ),
    color = "red",
    linewidth = 1.5,
    fill = "transparent"
  )+
    scale_y_continuous(
      # expand = expansion(mult = c(0,0)),
      # n.breaks = 8,
      # limits = c(-35, 6),
      breaks = c(-30, -20, -10, 0),
      # labels = c("1", "2", "3", "4", "5", "6", "7", "8", "9")
    )+
    scale_x_continuous(
      # expand = expansion(mult = c(0,0)),
      # n.breaks = 8,
      # limits = c(-35, 6),
      breaks = c(-65, -50, -35),
      # labels = c("1", "2", "3", "4", "5", "6", "7", "8", "9")
    )+
    coord_sf(
      xlim = c(-77, -32),
      ylim = c(-35, 6.2),
      expand = FALSE,
    )+
    theme_minimal_grid()+
    theme(
       plot.margin = margin(
        t = 0.06, 
        r = 0.06, 
        b = 0.06, 
        l = 0.06, 
        unit = "npc"
      ),
      plot.background = element_rect(
        fill = "white",
        color = "black",
        linewidth = 1,
        ),
      axis.text.x = element_text(size = 8),
      axis.text.y = element_text(size = 8),
    )
)

(inset_map_rs <- ggplot()+
    geom_sf(
      data = estados_br %>% filter(abbrev_state == "SC" | abbrev_state == "PR"),
      fill = "transparent",
      alpha = 0.5
    )+
    # geom_sf(
    #   data = estados_br %>% filter(abbrev_state == "RS"),
    #   fill = "grey",
    #   alpha = 0.5
    # )+
    geom_sf(
      data = RHG %>% filter(nome != "Guaíba"),
      fill = "grey90",
      alpha = 0.5
    )+
    geom_sf(
      data = RHG %>% filter(nome == "Guaíba"),
      fill = "grey50",
      alpha = 0.5
    )+
    # st_bbox(BH_gravatai)
    geom_sf(
      data = municipios_RS %>% filter(code_muni == 4300002),
      # color = "#5cacee",
      color = "grey30",
      fill = "#5cacee",
    )+
    # geom_sf(
    #   data = municipios_RS,
    #   fill = "transparent",
    # )+
    geom_rect(
      aes(
        xmin = -50.4*0.995, xmax = -51.3*1.005,
        ymin = -29.7*0.995, ymax = -30.3*1.005,
      ),
      color = "red",
      linewidth = 1.0,
      fill = "transparent"
    )+
    geom_sf(
      data = BH_gravatai,
      alpha = 0.9,
      color = "red",
      fill = "yellow"
    )+
    labs(
      x = NULL,
      y = NULL,
    )+
    scale_y_continuous(
      breaks = c(-34, -30, -26),
    )+
    scale_x_continuous(
      breaks = c(-57, -54, -51, -48),
    )+
    coord_sf(
      xlim = c(-58, -48),
      ylim = c(-34, -26),
      expand = FALSE,
    )+
    theme_minimal_grid()+
    theme(
      plot.margin = margin(
        t = 0.07, 
        r = 0.07, 
        b = 0.07, 
        l = 0.07, 
        unit = "npc"
      ),
      plot.background = element_rect(
        fill = "white",
        color = "black",
        linewidth = 1,
      ),
      axis.text.x = element_text(size = 8),
      axis.text.y = element_text(size = 8),
    )
)

plot(brasil)
plot(sul_br)
```

```{r criando elementos do mapa}
dummy_data <- tibble(x = 1:1000, y = 1:1000)
(elementos_do_mapa <- 
    ggplot(data = dummy_data)+
    # scale_x_continuous(name = "x")+
    # scale_y_continuous(name = "y")+
    
    ##### Base map
    geom_rect(
      data = dummy_data,
      aes(
        xmin = 0, xmax = 1000,
        ymin = 0, ymax = 1000,
      ),
      fill = "white",
      linetype = 1,
      color = "black",
      alpha = 0.5,
      border = TRUE
    )+
    
    ###### 
  # Limite BH
  geom_rect(
      aes(
        xmin = 20, xmax = 50,
        ymin = 900-25, ymax = 900+25,
      ),
      fill = "white",
      linetype = 1,
      linewidth = 1.1,
      color = "red",
      alpha = 0.5,
      border = TRUE
  )+
    geom_text(
      aes(
        x = 70,
        y = (200*4)+100,
        label = "Limite da Bacia Hidrográfica",
      ),
      fontface = "plain",
      hjust = 0,
      family = "",
      color = "black",
    )+
    ######
  # annotate(
  #   "text",
  #   label = c("Limite municipal", "Hidrografia", "Pontos de Monitoramento"),
  #   x = c(70, 60, 70),
  #   y = c(300, 110, 120),
  # )+
  # geom_linerange(
  #   aes(
  #     xmin = 20, xmax = 50,
  #     y = 300,
  #   ),
  #   color = "black",
  #   linewidth = 1.2,
  # )+
  
  ####### Limite municipal
    geom_rect(
      aes(
        xmin = 20, xmax = 50,
        ymin = ((200*3)+100)-25, ymax = ((200*3)+100)+25,
      ),
      fill = "white",
      linetype = 1,
      linewidth = 0.8,
      color = "black",
      # alpha = 0.5,
      border = TRUE
  )+
    geom_text(
      aes(
        x = 70,
        y = (200*3)+100,
        label = "Limite municipal",
      ),
      fontface = "plain",
      hjust = 0,
      family = "",
      color = "black",
    )+
    
    ###### Hidrografia
    geom_linerange(
    aes(
      xmin = 20, xmax = 50,
      y = (200*2)+100,
      # ymin = 0, ymax = 50,
    ),
    color = "#5cacee",
    linewidth = 1,
  )+
    geom_text(
      aes(
        x = 70,
        y = (200*2)+100,
        label = "Hidrografia",
      ),
      fontface = "plain",
      hjust = 0,
      family = "",
      color = "black",
    )+
    
    ####### Pontos de monitoramento
    geom_point(
      aes(
        x = (50+20)/2,
        y = (200*1)+100,
        # label = codigo,
      ),
      shape = 21,
      size = 2.4,
      stroke = 1.2,
      color = "black",
      fill = "white",
    )+
     geom_text(
      aes(
        x = 70,
        y = (200*1)+100,
        label = "Pontos de monitoramento",
      ),
      fontface = "plain",
      hjust = 0,
      family = "",
      color = "black",
    )+
    labs(
      title = "Elementos do mapa",
      x = NULL,
      y = NULL,
    )+
    
    #####
  # Segunda coluna
  geom_text(
      aes(
        x = 500,
        y = 900,
        label = "Referências espaciais",
      ),
      fontface = "bold",
      size = 3,
      hjust = 0,
      family = "",
      color = "black",
    )+
    geom_text(
      aes(
        x = 500,
        y = 825,
        label = "Datum: SIRGAS2000\nSistema de Projeção UTM\nFuso 22 Sul",
      ),
      fontface = "plain",
      hjust = 0,
      vjust = 1,
      size = 2.5,
      lineheight = 0.7,
      family = "",
      color = "black",
    )+
    
    geom_text(
      aes(
        x = 500,
        y = 250*2,
        label = "Fonte",
      ),
      fontface = "bold",
      size = 3,
      hjust = 0,
      family = "",
      color = "black",
    )+
    geom_text(
      aes(
        x = 500,
        y = 225*2,
        label = 
          "Limite municipal: IBGE (2018)\nLimite Bacia Hidrográfica: BCRS25/SEMA-RS (2018)\nPontos de Monitoramento Qualidade da Água: \nFEPAM/DIPLAN (2019)\n\nElaboração:\nLeonardo Fernandes Wink, 2023",
      ),
      fontface = "plain",
      hjust = 0,
      vjust = 1,
      size = 2.5,
      lineheight = 0.7,
      family = "",
      color = "black",
    )+
  #####
  theme_void()+
    theme(
      plot.margin = margin(t = 0.03, r = -0.03, b = -0.0, l = -0.03, "npc"),
      plot.background = element_rect(
        fill = "white",
        color = "black",
        linewidth = 1,
      ),
      plot.title = element_text(
        hjust = 0.1,
        face = "bold",
        size = 13,
        margin = margin(t = 0.03, r = 0, b = -0.03, l = 0, "npc"),
      )
    )
)
```

```{r}
set.seed(2)
(mapa_localizacao_BHG <- ggdraw()+
  draw_plot(
    mapa_localizacao_est_BHG,
    # hjust = 0,
    x = 0,
    y = 0.10,
    # scale = TRUE,
    halign = 0,
    valign = 1,
    width = 1,
    height = 1
  )+
  draw_plot(
    inset_map_br,
    x = -0.025,
    y = 0,
    scale = TRUE,
    hjust = 0,
    vjust = 0,
    halign = 0,
    valign = 0,
    height = 0.25,
    width = 0.25
  )+
  draw_plot(
    inset_map_rs,
    # x = 0.19, #pode ser um pouco menos
    x = 0.18,
    # x = 0.175, #tem q ser mais
    y = 0,
    scale = TRUE,
    hjust = 0,
    vjust = 0,
    halign = 0,
    valign = 0,
    height = 0.25,
    width = 0.25
  )+
  draw_plot(
    elementos_do_mapa,
    # x = 0.4,
    x = 0.41,
    y = 0,
    scale = TRUE,
    hjust = 0,
    vjust = 0,
    halign = 0,
    valign = 0,
    # valign = 0,
    height = 0.25,
    width = 0.59
  )+
   theme(
     plot.margin = margin(
       t = 0.01, 
       r = 0.01, 
       b = 0.01, 
       l = 0.01, 
       unit = "npc"
     ),
     plot.background = element_rect(
       fill = "white",
       color = "black",
       linewidth = 1,
     ),
   )
)
```

```{r mapa com PMs}
set.seed(10) #better
# set.seed(11) #even better
# set.seed(26) #good
(mapa_localizacao_BHG <- ggdraw()+
  draw_plot(
    mapa_localizacao_est_BHG,
    x = 0,
    y = 0.10,
    # scale = TRUE,
    halign = 0,
    valign = 1,
    width = 1,
    height = 1.1
  )+
  draw_plot(
    inset_map_br,
    # x = -0.035, #mais
    x = -0.034,
    # x = -0.03, # menos
    y = 0,
    scale = TRUE,
    hjust = 0,
    vjust = 0,
    halign = 0,
    valign = 0,
    height = 0.30,
    width = 0.30
  )+
  draw_plot(
    inset_map_rs,
    # x = 0.20, # mais
    x = 0.21, 
    # x = 0.22, #menos
    y = 0,
    scale = TRUE,
    hjust = 0,
    vjust = 0,
    halign = 0,
    valign = 0,
    height = 0.30,
    width = 0.30
  )+
  draw_plot(
    elementos_do_mapa,
    # x = 0.48, #mais
    x = 0.49,
    # x = 0.5, #menos
    y = 0,
    scale = TRUE,
    hjust = 0,
    vjust = 0,
    halign = 0,
    valign = 0,
    # valign = 0,
    height = 0.30,
    # width = 0.50 #mais
    width = 0.51
    # width = 0.53 #menos
  )+
   theme(
     plot.margin = margin(
       t = 0.01, 
       r = 0.01, 
       b = 0.01, 
       l = 0.01, 
       unit = "npc"
     ),
     plot.background = element_rect(
       fill = "white",
       color = "black",
       linewidth = 1,
     ),
   )
)
```


### salvando mapa
```{r salvando mapa localização estações}
ggsave(
  filename = "mapa_localizacao_BHG.png",
  plot = mapa_localizacao_BHG,
  units = c("px"),
  width = (4500)/1.5,
  height = (2993)/1.5,
  path = "./info_geoespaciais",
  dpi = 300,
  type = "cairo"
)
```

## mapa balanço qualitativo-quantitativo ANA

```{r mapa_qualiquant}
plot(BH_gravatai)
plot(balanco_qualiquant)

balanco_hidrico_BHG <- tmaptools::crop_shape(
  balanco_qualiquant$geom, 
  BH_gravatai$geometry,
  polygon = TRUE
) %>% 
  st_as_sf() %>% 
  st_transform(crs = 31982) %>% #4326 = WGS84, 4674 = SIRGAS2000, 31982 = SIRGAS2000/UTM 22S
  st_join(
    balanco_qualiquant,
  )

str(balanco_qualiquant)

st_crs(balanco_qualiquant) == st_crs(BH_gravatai)

st_crs(balanco_qualiquant) == st_crs(balanco_hidrico_BHG)

balanco_hidrico_BHG %>% 
  # rename(
  #   "Relação entre carga orgânica lançada e a assimilável" = BLN_CS_QUA
  # )
  ggplot(
    aes(fill = BLN_CS_QUA)
  )+
  geom_sf()+
  labs(
    title = "Balanço hídrico na Bacia Hidrográfica do rio Gravataí",
    x = "Longitude",
    y = "Latitude",
  )+
  theme_bw()+
  theme(
    plot.title = element_text(
        size = 16,
        hjust = 0.5,
        color = "black",
        face = "bold"
      ),
    legend.position = "bottom",
    legend.direction = "horizontal",
    legend.key.size = unit(0.5, "cm"),
  )
```

## Mapa interativo

```{r base_mapa_interativo}
mapa_interativo <- plan_wide_19902020 %>% 
  leaflet() %>% 
  setView(
    lat = -30,
    lng = -50.9,
    zoom = 10
  ) %>%
  addSimpleGraticule(
    interval = 5,
    showOriginLabel = FALSE,
  ) %>% 
   addProviderTiles(
    # "Esri.WorldImagery" #Imagem de satélite
    "OpenStreetMap.Mapnik" #OpenStreetMap -> Software livre
  ) %>% 
  # addPolygons(
  #   data = lim_mun_RJ,
  #   color = "red",
  #   fill = FALSE,
  #   weight = 2.5,
  #   opacity = 1,
  # ) %>% 
  addScaleBar(
    # map,
    position = "bottomright",
    options = scaleBarOptions(
      maxWidth = 150,
      metric = TRUE,
      imperial = FALSE,
      updateWhenIdle = TRUE
    )
  )
```

## mapa com as estações de monitoramento ao longo da bacia

```{r mapa_interativo_estações}
mapa_interativo %>%
  addCircleMarkers(
    data = plan_wide_19902020,
    lng = ~longitude,
    lat = ~latitude,
    radius = 4,
    fillOpacity = 0.6,
    color = "blue",
    popup = ~paste0(
      "<b>Ponto de monitoramento: </b>", {ponto_monitoramento}, "<br>",
      "<b>Código: </b>", codigo, "<br>",
      "<b>Endereço: </b>", {endereco}, "<br>",
      "<b>Município: </b>", municipio, "<br>",
      "<b>Recurso hídrico: </b>", recurso_hidrico, "<br>",
      "<b>Altitude: </b>", altitude, "<br>",
      "<b>Última coleta: </b>", tail(data_coleta, 1), "<br>",
      sep = " "
    )
  )
```

# Introdução

estiagem -\> conflitos -\> uso da água

Um dos problemas recorrentes da bacia é a estiagem.

# Resultados

-   § falar do comportamento geral dos dados
-   2º § - xº § -\> abordar os principais parâmetros que estão sendo impactados, detalhando, nas estações mais relevantes, como ficaram os quartis/mediana etc.

<!--# ainda falta ajustar a formatação das casas decimais. talvez fazer um =left() e =right(), que nem no excel -->

## comportamento geral dos dados

### Número de amostras/NAs

Dentre os parâmetros selecionados para a análise, todos, com exceção ao nitrogênio amoniacal, possuíram mais de 85% dos valores medidos, das 1.179 amostras totais. O nitrogênio amoniacal teve `r eda_all_time %>% filter(skim_variable == "nitrogenio_amoniacal") %>% .[4] %>% pluck(1) %>% percent()` de registros com `r eda_all_time %>% filter(skim_variable == "nitrogenio_amoniacal") %>% .[3] %>% pluck(1)` dados faltantes. A temperatura da água foi o parâmetro mais completo, com `r eda_all_time %>% filter(skim_variable == "temperatura_agua") %>% .[4] %>% pluck(1) %>% percent()` das medições e apenas `r eda_all_time %>% filter(skim_variable == "temperatura_agua") %>% .[3] %>% pluck(1)` dados faltantes.

### boxplots

> recapitulação de onde estão as estações

De modo geral, as estações de monitoramento apresentaram comportamentos similares em dois grupos: o primeiro dos pontos PM1, PM2, PM3 e PM4 e o segundo grupo dos pontos PM5, PM6 e PM7. Podemos distinguir, visualmente, através dos gráficos, esses agrupamentos, ou *clusters*. Isso ocorre devido a localização dessas estações. Os pontos PM1, PM2 estão situadas no trecho do Alto Gravataí, o PM3 no Médio Gravataí e, por fim, o PM4, já no Baixo Gravataí. Esse primeiro *cluster* recebe contribuição semelhante: lavouras (de arroz), campos e área de banhado. Embora o PM4 esteja dentro do perímetro do Baixo Gravataí, ele recebe, comparativamente às estações à jusante, menos contribuição antrópica. Os pontos PM5, PM6 e PM7, por outro lado, estão situados no trecho mais populosamente denso da bacia, o do Baixo Gravataí.

#### Tendência montante-jusante

Os resultados apontam que há uma queda na qualidade da água no sentido montante-jusante para os parâmetros OD, DBO, Fósforo total, Nitrogênio amoniacal e condutividade elétrica. A *E. coli* teve, durante a primeira década, melhora da qualidade ao longo do rio, contudo, houve uma reversão na tendência para os dois períodos subsequentes.

### graf over time

### principais parâmetros impactados

## parâmetro 1 - od

No parâmetro OD, quanto maior o valor medido, melhor. Devido a essa característica, este é o único parâmetro em que a classe é definida pelo P20, e não pelo P80.

Valores acima de 2 mg/L são essenciais para a sobrevivência de organismos aquáticos. O OD teve os valores máximos e P95, de todas as estações, dentro do limite da Classe 1. Apenas os pontos PM5, PM6 e PM7, no período 2010-2020, registraram valores dentro do limite da Classe 2.

No período 1990-2000, as medianas dos pontos PM1, PM2 e PM3 foram maiores que 6 mg/L, dentro do intervalo da Classe 1. O PM4 teve resultado muito próximo à Classe 1, de `r sum_od_p1$PM4[4]` mg/L, mas já dentro do limite da Classe 2. Para o PM5 foi calculada mediana de `r sum_od_p1$PM5[4]` mg/L, Classe 3. Para as duas estações mais próximas da foz, PM6 e PM7, os valores encontrados foram compreendidos dentro do intervalo da Classe 4, com `r sum_od_p1$PM6[4]` e `r sum_od_p1$PM7[4]` mg/L, respectivamente.

Para o ponto PM1, em 80% do tempo, para cada um dos três períodos de análise, a qualidade foi igual ou melhor a Classe 4.

No período 2000-2010, a mediana do PM1 esteve dentro da Classe 3, enquanto as estações PM2, PM3 e PM4 tiveram valores na Classe 2. Os pontos PM5 e PM7 oscilaram dentro do limite da Classe 4. A pior mediana registrada para esse período foi o PM6, com valor de `r sum_od_p2$PM6[4]` mg/L, abaixo do limite da pior classe. O P20, no período 2000-2010, esteve dentro da Classe 4 para os pontos PM1, PM2, PM3 e PM4. As demais três estações apresentaram valores abaixo do limite da Classe 4.

Os pontos PM2, PM4, PM6 e PM7 foram significativamente impactados pela falta de medições. Os pontos PM2 e PM6 começaram a ser monitorados a partir de 1998. Entretanto, os pontos PM4 e PM7 ficaram por um longo período sem coleta, de 1998 a 2005.

A estação que teve os melhores valores registrados para o parâmetro OD foi a PM2 e a pior a PM6, para todos os períodos selecionados.

### boxplots 1

#### tendencia mont-jus 1

### graf overtime 1

#### comportamento est est 1

### quando foram os NAs 1

A turbidez registrou, ao sumarizar a série por período, valores médios de `r plan_wide_19902020 %>% group_by(periodo) %>% dplyr::select(turbidez, periodo) %>% skim() %>% dplyr::select(-numeric.hist) %>% .[1,6] %>% pluck(1) %>% formattable(digits = 3, format = "f")`, `r plan_wide_19902020 %>% group_by(periodo) %>% dplyr::select(turbidez, periodo) %>% skim() %>% dplyr::select(-numeric.hist) %>% .[2,6] %>% pluck(1) %>% formattable(digits = 3, format = "f")` e `r plan_wide_19902020 %>% group_by(periodo) %>% dplyr::select(turbidez, periodo) %>% skim() %>% dplyr::select(-numeric.hist) %>% .[3,6] %>% pluck(1) %>% formatC(digits = 3, format = "f")` UNT, respectivamente.

# Discussão

O ano de 2007 foi marcado por uma forte estiagem. [^1]

[^1]: [Link](https://metsul.com/estiagem-completa-200-dias-e-atinge-niveis-historicos-para-maio/)

A redução dos valores de turbidez no período 2010-2020 ocorreu por conta de ações tomadas pelo setor público: Fepam, Brigada ambiental. [^2]

[^2]: Inserir referência.

## Estiagem

Segundo dados do metsul [^3], os anos de 1991, 1995, 1996, 1997, 2000, 2001 e 2011 foram marcados pela estiagem. O ano de 2022 teve a pior seca dos últimos 18 anos [\^4]

[^3]: [Link2](https://www.brasildefato.com.br/2022/01/07/rio-grande-do-sul-tem-a-pior-seca-dos-ultimos-17-anos-e-perdas-chegam-a-r-20-bilhoes)

Dessa forma, é imprescindível que o Estado continue promovendo ações para aumentar o tempo de permanência da água nos rios, como foi feito através da construção de barramentos e renaturalização do trecho retilinizado (Canal DNOS).

# Gráficos exemplos boxplot

```{r elementos do boxplot}
set.seed(2023)
exemplo_boxplot_df <- data.frame(
  PM = c("PM1"),
  # letras = letters[seq( from = 1, to = 1 )],
  Stat1 = rnorm(100, 
                mean = 5, 
                sd = 1.8)
)

(sumario_exemplo_bp <- exemplo_boxplot_df %>% 
    group_by(PM) %>% 
    summarize(
      max = max(Stat1),
      p95 = quantile(Stat1, 0.95),
      p80 = quantile(Stat1, 0.8),
      median = median(Stat1),
      p20 = quantile(Stat1, 0.2),
      p05 = quantile(Stat1, 0.05),
      min = min(Stat1),
    ) %>% 
    t() %>% 
    row_to_names(row_number = 1) %>% 
    as.numeric()
)


(boxplot_example <- exemplo_boxplot_df %>% 
    ggplot(
      aes(
        x = PM,
        y = Stat1,
      )
    )+
    stat_summary(
      fun.data = f,
      geom = 'errorbar',
      width = 0.15,
      position = position_dodge(width = 0.65),
    )+
    stat_summary(
      fun.data = f,
      geom = "boxplot",
      width = 0.40,
      fill = '#F8F8FF',
      color = "black",
      outlier.shape = NA, #se deixar NA fica só o jitter, se não, deixa 1
    )+
    labs(
      title = "Elementos do *boxplot*",
      x= NULL,
      y= NULL
    )+
    ggbeeswarm::geom_quasirandom(
      size = 1.4,
      alpha = .3,
      width = .07,
    )+
    scale_y_continuous(
      expand = expansion(mult = c(0,0)),
      n.breaks = 8,
      limits = c(-0.3,12)
    )+
    annotate(
      geom = "text",
      x = 1.55,
      hjust = "right",
      y = sumario_exemplo_bp,
      label = c("Valor máximo", "P95", "P80", "Mediana", "P20", "P05", "Valor mínimo"),
      # fontface = 3
    )+
    geom_richtext(
      x = 0.56,
      y = 9.103998,
      label.color = NA,
      hjust = "center",
      label = "<i>Outliers</i>"
    )+
    geom_curve(
      aes(
        x = 0.6, xend = 0.98,
        y = 9.103998 , yend = 9.103998 , #Outliers
      ),
      curvature = 0,
      size = 1.0,
      arrow = arrow(length = unit(0.05, "npc")),
      lineend = "round"
    )+
    #definindo o [
    geom_curve(
      aes(
        x = 0.74, xend = 0.78,
        y = 6.683828, yend = 6.683828,
      ),
      curvature = 0,
      size = 1.0,
      lineend = "butt"
    )+
    geom_curve(
      aes(
        x = 0.74, xend = 0.74,
        y = 3.545771, yend = 6.683828,
      ),
      curvature = 0,
      size = 1.0,
      lineend = "butt"
    )+
    annotate(
      geom = "text",
      x = 0.56,
      hjust = "center",
      y = 5.11,
      label = "Amplitude\n(P80-P20)"
    )+
    geom_curve(
      aes(
        x = 0.74, xend = 0.78,
        y = 3.545771 , yend = 3.545771 ,
      ),
      curvature = 0,
      size = 1.0,
      lineend = "butt"
    )+
    # fim do [
    geom_curve(
      aes(
        x = 0.6, xend = 0.90,
        y = 7.866927 , yend = 7.866927 , #whisker superior
      ),
      curvature = 0,
      size = 1.0,
      arrow = arrow(length = unit(0.05, "npc")),
      lineend = "round"
    )+
    annotate(
      geom = "text",
      x = 0.56,
      hjust = "center",
      y = 7.866927,
      label = "Whisker\nsuperior"
    )+
    geom_curve(
      aes(
        x = 0.6, xend = 0.90,
        y = 2.277104  , yend = 2.277104  , #whisker inferior
      ),
      curvature = 0,
      size = 1.0,
      arrow = arrow(length = unit(0.05, "npc")),
      lineend = "round"
    )+
    annotate(
      geom = "text",
      x = 0.56,
      hjust = "center",
      y = 2.277104,
      label = "Whisker\ninferior"
    )+
    geom_curve(
      aes(
        x = 1.4, xend = 1.01,
        y = 9.92343, yend = 9.92343, #valor máximo
      ),
      curvature = 0,
      size = 1.0,
      arrow = arrow(length = unit(0.05, "npc")),
      lineend = "round"
    )+
    geom_curve(
      aes(
        x = 1.45, xend = 1.11,
        y = 7.866927 , yend = 7.866927 , #P95
      ),
      curvature = 0,
      size = 1.0,
      arrow = arrow(length = unit(0.05, "npc")),
      lineend = "round"
    )+
    geom_curve(
      aes(
        x = 1.45, xend = 1.22,
        y = 6.683828  , yend = 6.683828  , #P80
      ),
      curvature = 0,
      size = 1.0,
      arrow = arrow(length = unit(0.05, "npc")),
      lineend = "round"
    )+
    geom_curve(
      aes(
        x = 1.45, xend = 1.22,
        y = 4.886935   , yend = 4.886935   , #P50
      ),
      curvature = 0,
      size = 1.0,
      arrow = arrow(length = unit(0.05, "npc")),
      lineend = "round"
    )+
    geom_curve(
      aes(
        x = 1.45, xend = 1.22,
        y = 3.545771, yend = 3.545771, #P20
      ),
      curvature = 0,
      size = 1.0,
      arrow = arrow(length = unit(0.05, "npc")),
      lineend = "round"
    )+
    geom_curve(
      aes(
        x = 1.45, xend = 1.11,
        y = 2.277104, yend = 2.277104, #P05
      ),
      curvature = 0,
      size = 1.0,
      arrow = arrow(length = unit(0.05, "npc")),
      lineend = "round"
    )+
    geom_curve(
      aes(
        x = 1.4, xend = 1.01,
        y = 1.282177, yend = 1.282177, #valor mínimo
      ),
      curvature = 0,
      size = 1.0,
      arrow = arrow(length = unit(0.05, "npc")),
      lineend = "round"
    )+
    # theme_grafs()+
    theme_bw()+
    theme(
      plot.title = 
        element_markdown(
          hjust = 0.5,
          color = "black",
          size = 19),
    )
)
```

```{r salvando graf elementos boxplot}
ggsave(
  filename = "exemplo_boxplot.png",
  plot = boxplot_example,
  units = c("px"),
  width = (4500)/1.5,
  height = (2993)/1.5,
  path = "./graficos",
  dpi = 300,
  # type = "cairo"
)
```

```{r criando exemplo tipos boxplot tukey x garrett}
set.seed(2021)

data <- tibble(
  grupo = factor(
    c(rep(
      "Grupo 1", 100), 
      rep("Grupo 2", 250), 
      rep("Grupo 3", 25)
    )
  ),
  valor = c(seq(0, 20, length.out = 100),
            c(rep(0, 5), 
              rnorm(30, 2, .1), 
              rnorm(90, 5.4, .1), 
              rnorm(90, 14.6, .1), 
              rnorm(30, 18, .1), 
              rep(20, 5)
            ),
            rep(seq(0, 20, length.out = 5), 5))
) %>% 
  rowwise() %>%
  mutate(
    valor = if_else(
      grupo == "Grupo 2", valor + rnorm(1, 0, .4), 
      valor
      )
    )

## function to return median and labels
n_fun <- function(x){
  return(
    data.frame(
      y = median(x) - 1.25, 
      label = paste0(
        "n = ",length(x)
      )
    )
  )
}
```

```{r tukey boxplot}
(tukey_n_boxplot <- ggplot(data, 
                           aes(x = grupo, 
                               y = valor)
)+
  stat_boxplot(geom = 'errorbar',
               width = 0.15,
               position = position_dodge(width = 0.65))+
  geom_boxplot(fill = "grey92",
               width = 0.40,
               position = position_dodge(width = 0.65))+
  ## use summary function to add text labels
  stat_summary(
    geom = "text",
    fun.data = n_fun,
    # family = "Oswald",
    size = 5
  )+
  labs(
    title = "Tukey *boxplot*",
    x= NULL,
    # y="mg/L"
  )+
  # theme_grafs()+
  theme_bw()+
  theme(
    axis.text.y = element_text(
      angle = 90, 
      # size=15,
      # face=2
    ),
    plot.title = 
      element_markdown(
        hjust = 0.5,
        color = "black",
        size = 19)
  )
)


(tukey_boxplot <- ggplot(data, aes(x = grupo, 
                                   y = valor)) +
  stat_boxplot(geom = 'errorbar',
               width = 0.15,
               position = position_dodge(width = 0.65))+
  geom_boxplot(fill = "grey92",
               width = 0.40,
               position = position_dodge(width = 0.65)) +
  ## use either geom_point() or geom_jitter()
  geom_point(
    ## draw bigger points
    size = 2,
    ## add some transparency
    alpha = .25,
    ## add some jittering
    position = position_jitter(
      ## control randomness and range of jitter
      seed = 1, width = .2
    )
  )+
  theme_bw()+
  labs(
      title = "Tukey *boxplot*",
      x= NULL,
      # y="mg/L"
    )+
  # theme_grafs()+
  theme_bw()+
  theme(
        axis.text.y = element_text(
          angle = 90, 
          # size=15,
          # face=2
        ),
        plot.title = 
          element_markdown(
            hjust = 0.5,
            color = "black",
            size = 19)
    ))
```

```{r garrett boxplot}
data %>% 
  group_by(grupo) %>% 
  summarize(
    min = min(valor),
    P20 = quantile(valor, 0.20),
    q1 = quantile(valor, 0.25),
    mediana = median(valor),
    q3 = quantile(valor, 0.75),
    P80 = quantile(valor, 0.80),
    max = max(valor)
  ) %>% 
  t() %>% 
  row_to_names(row_number = 1)
  
  
(box_percentile_plot <- ggplot(data, 
       aes(x = grupo, y = valor)
       ) +
      stat_summary(
        fun.data = f,
        geom = 'errorbar',
        width = 0.15,
        position = position_dodge(width = 0.65),
      )+
      stat_summary(
        fun.data = f,
        geom = "boxplot",
        width = 0.40,
        fill = 'grey92',
        color = "black",
        outlier.shape = NA, #se deixar NA fica só o jitter, se não, deixa 1
      )+
  # geom_boxplot(fill = "grey92") +
  ## use either geom_point() or geom_jitter()
  geom_point(
    ## draw bigger points
    size = 2,
    ## add some transparency
    alpha = .25,
    ## add some jittering
    position = position_jitter(
      ## control randomness and range of jitter
      seed = 1, width = .2
    )
  )+
  labs(
      title = "*Box Percentile-Plot*",
      x= NULL,
      # y="mg/L"
    )+
  # theme_grafs()+
  theme_bw()+
  theme(
        axis.text.y = element_text(
          angle = 90, 
          # size = 15,
          # face = 2
        ),
        plot.title = 
          element_markdown(
            hjust = 0.5,
            color = "black",
            size = 19)
    )
  )
grid.arrange(
  tukey_boxplot, box_percentile_plot, 
  ncol = 2
  )
fig_tukey_garrett <- plot_grid(tukey_boxplot, box_percentile_plot,
                               labels = "AUTO")
```

```{r salvando graf exemplo boxplot}
ggsave(
  filename = "tukey_n_boxplot.png",
  plot = tukey_n_boxplot,
  units = c("px"),
  width = 4500,
  height = 2993,
  path = "./graficos",
  dpi = 300,
  # type = "cairo"
)

ggsave(
  filename = "tukey_boxplot.png",
  plot = tukey_boxplot,
  units = c("px"),
  width = 4500,
  height = 2993,
  path = "./graficos",
  dpi = 300,
  # type = "cairo"
)

ggsave(
  filename = "box_percentile_plot.png",
  plot = box_percentile_plot,
  units = c("px"),
  width = 4500,
  height = 2993,
  path = "./graficos",
  dpi = 300,
  # type = "cairo"
)

ggsave(
  filename = "fig_tukey_garrett.png",
  plot = fig_tukey_garrett,
  units = c("px"),
  width = 4500,
  height = 2993,
  path = "./graficos",
  dpi = 300,
  # type = "cairo"
)
```
